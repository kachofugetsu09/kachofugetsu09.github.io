# MySQL æ ¸å¿ƒæ¦‚å¿µç¬”è®°

## SQL è¯­å¥çš„æ‰§è¡Œé€»è¾‘

> ðŸ”‘ **æ ¸å¿ƒè¦ç‚¹**ï¼šSQLè¯­å¥åœ¨MySQLä¸­çš„æ‰§è¡Œæ˜¯ä¸€ä¸ªå¤šé˜¶æ®µåä½œçš„è¿‡ç¨‹ï¼Œæ¶‰åŠè¿žæŽ¥å™¨ã€è§£æžå™¨ã€ä¼˜åŒ–å™¨ç­‰å¤šä¸ªç»„ä»¶ï¼Œæ—¨åœ¨ç¡®ä¿å®‰å…¨ã€é«˜æ•ˆã€å‡†ç¡®åœ°å¤„ç†æ•°æ®ã€‚

### æ˜¯ä»€ä¹ˆ

SQL è¯­å¥åœ¨ MySQL æ•°æ®åº“ä¸­çš„æ‰§è¡Œæµç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºä»¥ä¸‹æ ¸å¿ƒç»„ä»¶çš„ååŒå·¥ä½œï¼š

1.  **è¿žæŽ¥å™¨ (Connector)**ï¼šè´Ÿè´£å®¢æˆ·ç«¯ä¸Žæ•°æ®åº“çš„**è¿žæŽ¥å»ºç«‹ã€èº«ä»½è®¤è¯å’Œä¼šè¯ç®¡ç†**ï¼Œç»´æŠ¤è¿žæŽ¥çš„æƒé™åŠçŠ¶æ€ã€‚
2.  **æŸ¥è¯¢ç¼“å­˜ (Query Cache)**ï¼š**ï¼ˆMySQL 8.0 ä¹‹å‰ï¼‰** ç¼“å­˜å®Œæ•´çš„ SQL è¯­å¥åŠå…¶ç»“æžœé›†ï¼Œç›¸åŒæŸ¥è¯¢å¯ç›´æŽ¥è¿”å›žç¼“å­˜ã€‚
3.  **è§£æžå™¨ (Parser)**ï¼šå¯¹ SQL è¯­å¥è¿›è¡Œ**è¯æ³•åˆ†æžï¼ˆæ‹†åˆ† Tokenï¼‰**å’Œ**è¯­æ³•åˆ†æžï¼ˆç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ ASTï¼‰**ï¼Œæ£€æŸ¥è¯­æ³•é”™è¯¯ã€‚
4.  **é¢„å¤„ç†å™¨ (Preprocessor / Semantic Analyzer)**ï¼šåœ¨è¯­æ³•æ­£ç¡®åŸºç¡€ä¸Šï¼Œè¿›è¡Œ**è¯­ä¹‰æ ¡éªŒ**ï¼Œå¦‚æ£€æŸ¥è¡¨/åˆ—æ˜¯å¦å­˜åœ¨åŠæƒé™ï¼Œå¹¶è¿›è¡Œç±»åž‹æŽ¨å¯¼ã€‚
5.  **ä¼˜åŒ–å™¨ (Optimizer)**ï¼šSQL æ‰§è¡Œçš„**"å¤§è„‘"**ã€‚æ ¹æ®æˆæœ¬æ¨¡åž‹ã€ç»Ÿè®¡ä¿¡æ¯ï¼Œåˆ†æž ASTï¼Œ**ç”Ÿæˆå¹¶é€‰æ‹©æœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’**ï¼ˆå¦‚é€‰æ‹©ç´¢å¼•ã€è¿žæŽ¥é¡ºåºç­‰ï¼‰ã€‚
6.  **æ‰§è¡Œå™¨ (Executor)**ï¼šSQL æ‰§è¡Œçš„**"æ‰§è¡Œå¼•æ“Ž"**ã€‚æ ¹æ®ä¼˜åŒ–å™¨é€‰å®šçš„æ‰§è¡Œè®¡åˆ’ï¼Œè°ƒç”¨åº•å±‚å­˜å‚¨å¼•æ“ŽæŽ¥å£æ‰§è¡Œå…·ä½“çš„æ•°æ®æ“ä½œï¼ˆè¯»å†™ã€è¿‡æ»¤ã€æŽ’åºç­‰ï¼‰ï¼Œå¹¶è¿”å›žç»“æžœã€‚

### ä¸ºä»€ä¹ˆ

> ðŸ’¡ **è®¾è®¡ç†å¿µ**ï¼šæ¯ä¸ªé˜¶æ®µéƒ½æ‰¿è½½ç€ç‰¹å®šçš„å…³é”®èŒè´£ï¼Œå…±åŒç¡®ä¿æ•°æ®åº“çš„å®‰å…¨æ€§ã€ç¨³å®šæ€§ã€é«˜æ•ˆæ€§å’Œå¯æ‰©å±•æ€§ã€‚

1.  **è¿žæŽ¥å™¨çš„é‡è¦æ€§**ï¼šä½œä¸ºæ•°æ®åº“**å®‰å…¨çš„ç¬¬ä¸€é“é˜²çº¿**ï¼Œé€šè¿‡èº«ä»½éªŒè¯å’Œæƒé™ç®¡ç†ä¿éšœè®¿é—®å®‰å…¨ã€‚åŒæ—¶ï¼Œå®ƒç®¡ç†è¿žæŽ¥çš„ä¼šè¯ä¸Šä¸‹æ–‡ï¼Œä¸ºåŽç»­äº‹åŠ¡éš”ç¦»ç­‰æä¾›åŸºç¡€ã€‚
2.  **æŸ¥è¯¢ç¼“å­˜çš„æ¼”è¿›**ï¼šMySQL 8.0 ç§»é™¤æŸ¥è¯¢ç¼“å­˜ï¼Œæ ¸å¿ƒåŽŸå› æ˜¯å…¶**ç²—ç²’åº¦çš„å¤±æ•ˆæœºåˆ¶**ã€‚ä»»ä½•æ•°æ®ä¿®æ”¹éƒ½ä¼šå¯¼è‡´ç›¸å…³ç¼“å­˜å¤§è§„æ¨¡å¤±æ•ˆï¼Œåœ¨é«˜å¹¶å‘å’Œæ•°æ®é¢‘ç¹æ›´æ–°åœºæ™¯ä¸‹ï¼Œ**å‘½ä¸­çŽ‡æžä½Ž**ï¼Œåè€Œå¼•å…¥é¢å¤–çš„**ç»´æŠ¤å¼€é”€å’Œé”ç«žäº‰**ï¼Œæˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œä½“çŽ°äº†æ•°æ®åº“è®¾è®¡ä¸­å¯¹**å®žé™…æ€§èƒ½æƒè¡¡**çš„è€ƒé‡ã€‚
3.  **è§£æžå™¨çš„èŒè´£**ï¼šå°†äººç±»å¯è¯»çš„ SQL **ç¿»è¯‘æˆæœºå™¨å¯ç†è§£çš„ç»“æž„åŒ–æŒ‡ä»¤ï¼ˆASTï¼‰**ï¼Œæ˜¯æ‰€æœ‰åŽç»­å¤„ç†çš„åŸºç¡€ã€‚å…¶**æ—©æœŸè¯­æ³•æ£€æŸ¥**èƒ½åŠæ—¶å‘çŽ°é”™è¯¯ï¼Œé¿å…èµ„æºæµªè´¹ã€‚
4.  **é¢„å¤„ç†å™¨çš„ä½œç”¨**ï¼šå¼¥è¡¥çº¯è¯­æ³•æ£€æŸ¥çš„ä¸è¶³ï¼Œç¡®ä¿ SQL è¯­å¥åœ¨é€»è¾‘ä¸Š **"æœ‰æ„ä¹‰ä¸”åˆæ³•"** ï¼Œé˜²æ­¢æ“ä½œä¸å­˜åœ¨çš„å¯¹è±¡æˆ–è¶Šæƒè®¿é—®ï¼Œæ˜¯ä¿éšœæ•°æ®å®‰å…¨çš„å¿…è¦æ­¥éª¤ã€‚
5.  **ä¼˜åŒ–å™¨çš„æ ¸å¿ƒåœ°ä½**ï¼šä¼˜åŒ–å™¨æ˜¯æ•°æ®åº“æ€§èƒ½çš„ **"å†³ç­–æ ¸å¿ƒ"** ã€‚å®ƒå°†å£°æ˜Žå¼çš„ SQL è¯­å¥è½¬åŒ–ä¸ºé«˜æ•ˆçš„æ“ä½œåºåˆ—ï¼Œé€šè¿‡ç²¾å¯†çš„æˆæœ¬è¯„ä¼°ï¼ˆåŸºäºŽæ•°æ®é‡ã€ç´¢å¼•ã€æ‰«ææ–¹å¼ç­‰ï¼‰ï¼Œ**æ—¨åœ¨æœ€å°åŒ–ç£ç›˜ I/O å’Œ CPU æ¶ˆè€—**ã€‚ä¸€ä¸ªé«˜è´¨é‡çš„æ‰§è¡Œè®¡åˆ’å¯¹æŸ¥è¯¢æ€§èƒ½è‡³å…³é‡è¦ï¼Œæ˜¯ SQL è°ƒä¼˜çš„å…³é”®ã€‚
6.  **æ‰§è¡Œå™¨çš„å®žçŽ°**ï¼šå°†ä¼˜åŒ–å™¨çš„"è“å›¾"è½¬åŒ–ä¸ºå®žé™…æ“ä½œï¼Œä¸Žåº•å±‚å­˜å‚¨å¼•æ“Žç´§å¯†åä½œã€‚å…¶æ•ˆçŽ‡ç›´æŽ¥å—ä¼˜åŒ–å™¨è®¡åˆ’è´¨é‡å’Œå­˜å‚¨å¼•æ“Žèƒ½åŠ›çš„å½±å“ã€‚

---

## MySQL çš„å­˜å‚¨å¼•æ“Ž

> ðŸ”‘ **æ ¸å¿ƒè¦ç‚¹**ï¼šMySQL æ”¯æŒå¤šç§å­˜å‚¨å¼•æ“Žï¼Œå…¶ä¸­ InnoDB æ˜¯æœ€é‡è¦çš„äº‹åŠ¡åž‹å­˜å‚¨å¼•æ“Žï¼Œè€Œ MyISAM åˆ™é€‚ç”¨äºŽç‰¹å®šçš„éžäº‹åŠ¡æ€§åœºæ™¯ã€‚

### æ˜¯ä»€ä¹ˆ

MySQL çš„å­˜å‚¨å¼•æ“Žæ˜¯æ•°æ®åº“ç®¡ç†ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£æ•°æ®å­˜å‚¨ã€ç´¢å¼•ã€äº‹åŠ¡ç®¡ç†ã€å¹¶å‘æŽ§åˆ¶ã€å´©æºƒæ¢å¤ç­‰åº•å±‚æ“ä½œã€‚

1.  **InnoDB (é»˜è®¤ï¼Œäº‹åŠ¡åž‹)**ï¼š
    * **æ ¸å¿ƒç‰¹æ€§**ï¼šå…¨é¢æ”¯æŒ **ACID äº‹åŠ¡**ï¼›é‡‡ç”¨**è¡Œçº§é”**å®žçŽ°é«˜å¹¶å‘ï¼›æ”¯æŒ**å¤–é”®çº¦æŸ**ï¼›å…·å¤‡å¼ºå¤§çš„**å´©æºƒæ¢å¤èƒ½åŠ›**ï¼ˆé€šè¿‡ Redo Log å’Œ Undo Logï¼‰ã€‚
    * **ç´¢å¼•æœºåˆ¶**ï¼šå®žçŽ°**èšç°‡ç´¢å¼•**ï¼Œä¸»é”®ç´¢å¼•å³æ•°æ®æœ¬èº«ï¼›æ‰€æœ‰**è¾…åŠ©ç´¢å¼•**çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ä¸»é”®å€¼ï¼Œéœ€è¦**"å›žè¡¨"**æ‰èƒ½èŽ·å–å®Œæ•´æ•°æ®ã€‚
    * **é€‚ç”¨åœºæ™¯**ï¼šç»å¤§å¤šæ•°éœ€è¦**é«˜å¹¶å‘ã€å¼ºäº‹åŠ¡ä¸€è‡´æ€§**å’Œæ•°æ®å®Œæ•´æ€§çš„ OLTP (åœ¨çº¿äº‹åŠ¡å¤„ç†) åº”ç”¨ã€‚

2.  **MyISAM (éžé»˜è®¤ï¼Œéžäº‹åŠ¡åž‹)**ï¼š
    * **æ ¸å¿ƒç‰¹æ€§**ï¼š**ä¸æ”¯æŒäº‹åŠ¡ã€è¡Œçº§é”å’Œå¤–é”®**ï¼›åªæ”¯æŒ**è¡¨çº§é”**å¯¼è‡´é«˜å¹¶å‘å†™å…¥å·®ï¼›ä¸æ”¯æŒå´©æºƒæ¢å¤ã€‚
    * **ç´¢å¼•æœºåˆ¶**ï¼šå…¨éƒ¨é‡‡ç”¨**éžèšç°‡ç´¢å¼•**ï¼Œæ•°æ®æ–‡ä»¶ï¼ˆ.MYDï¼‰ä¸Žç´¢å¼•æ–‡ä»¶ï¼ˆ.MYIï¼‰**å®Œå…¨åˆ†ç¦»**ï¼›ç´¢å¼•å¶å­èŠ‚ç‚¹ç›´æŽ¥å­˜å‚¨**æ•°æ®è¡Œç‰©ç†åœ°å€**ï¼Œ**æ— éœ€"å›žè¡¨"**ã€‚
    * **é¢å¤–ç‰¹æ€§**ï¼šæ”¯æŒ**å…¨æ–‡ç´¢å¼•**ï¼›ç»´æŠ¤ç²¾ç¡®è¡Œæ•°è®¡æ•°å™¨ï¼Œ`SELECT COUNT(*)` æžå¿«ã€‚
    * **é€‚ç”¨åœºæ™¯**ï¼šå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸é«˜ã€ä»¥è¯»æ“ä½œä¸ºä¸»ä¸”å¹¶å‘å†™å…¥æžå°‘çš„åœºæ™¯ï¼Œå¦‚æ•°æ®ä»“åº“ä¸­çš„æŸäº›é™æ€åˆ†æžè¡¨ã€‚

3.  **Memory (å†…å­˜åž‹)**ï¼š
    * **æ ¸å¿ƒç‰¹æ€§**ï¼šæ•°æ®å®Œå…¨å­˜å‚¨åœ¨**å†…å­˜**ä¸­ï¼Œè®¿é—®æžå¿«ï¼›æ•°æ®**ä¸æŒä¹…åŒ–**ï¼ˆæœåŠ¡å™¨é‡å¯ä¸¢å¤±æ•°æ®ï¼‰ï¼›ä¸æ”¯æŒäº‹åŠ¡ã€è¡Œçº§é”å’Œå¤–é”®ã€‚
    * **é€‚ç”¨åœºæ™¯**ï¼šä¸´æ—¶è¡¨ã€é«˜é€Ÿç¼“å­˜ã€æ•°æ®åˆ†æžè¿‡ç¨‹ä¸­çš„ä¸­é—´ç»“æžœé›†ç­‰å¯¹æ•°æ®æŒä¹…æ€§æ— è¦æ±‚çš„åœºæ™¯ã€‚

### ä¸ºä»€ä¹ˆ

> ðŸ’¡ **InnoDB æˆä¸ºé»˜è®¤å¼•æ“Žçš„æ ¹æœ¬åŽŸå› **ï¼šå®ƒåœ¨æ•°æ®ä¸€è‡´æ€§ã€å®Œæ•´æ€§ã€å´©æºƒæ¢å¤å’Œé«˜å¹¶å‘æ€§æ–¹é¢æä¾›äº†æ›´å…¨é¢çš„ä¿éšœï¼Œæ›´ç¬¦åˆçŽ°ä»£ä¼ä¸šçº§åº”ç”¨çš„éœ€æ±‚ã€‚

1.  **äº‹åŠ¡æ”¯æŒ**ï¼šInnoDB å…¨é¢æ”¯æŒ **ACID äº‹åŠ¡**ï¼Œä»Žæ ¹æœ¬ä¸Šä¿è¯äº†æ•°æ®åœ¨å¤æ‚æ“ä½œå’Œç³»ç»Ÿæ•…éšœä¸‹çš„**ä¸€è‡´æ€§ä¸Žå®Œæ•´æ€§**ï¼Œè¿™æ˜¯å¤§å¤šæ•°å…³é”®ä¸šåŠ¡ç³»ç»Ÿä¸å¯æˆ–ç¼ºçš„ã€‚
2.  **å¹¶å‘æ€§èƒ½**ï¼šé€šè¿‡**è¡Œçº§é”**ï¼ŒInnoDB èƒ½å¤Ÿå°†é”çš„ç²’åº¦é™åˆ°æœ€ä½Žï¼Œæ˜¾è‘—å‡å°‘é”å†²çªï¼Œä»Žè€Œåœ¨å¤šç”¨æˆ·**é«˜å¹¶å‘è¯»å†™**åœºæ™¯ä¸‹æä¾›å‡ºè‰²çš„åžåé‡ï¼Œè¿œä¼˜äºŽ MyISAM çš„è¡¨çº§é”ã€‚
3.  **å´©æºƒæ¢å¤**ï¼šInnoDB å…·å¤‡å¼ºå¤§çš„**å´©æºƒæ¢å¤èƒ½åŠ›**ï¼Œé€šè¿‡ **Redo Log**ï¼ˆä¿éšœæŒä¹…æ€§ï¼Œå‰æ»šå·²æäº¤äº‹åŠ¡ï¼‰å’Œ **Undo Log**ï¼ˆä¿éšœåŽŸå­æ€§ï¼Œå›žæ»šæœªå®Œæˆäº‹åŠ¡ï¼‰æœºåˆ¶ï¼Œå³ä½¿åœ¨ç³»ç»Ÿçªç„¶å´©æºƒåŽä¹Ÿèƒ½ä¿è¯æ•°æ®ä¸ä¸¢å¤±å’Œäº‹åŠ¡çš„æ­£ç¡®æ€§ï¼Œè¿™æ˜¯ MyISAM æ— æ³•æ¯”æ‹Ÿçš„ã€‚



# æ•°æ®æ–‡ä»¶çš„å­˜å‚¨ç»“æž„ä¸Žç´¢å¼•

> ðŸ”‘ **æ ¸å¿ƒè¦ç‚¹**ï¼šæ•°æ®æ–‡ä»¶çš„å­˜å‚¨ç»“æž„å’Œç´¢å¼•æ˜¯å¯†ä¸å¯åˆ†çš„æ•´ä½“ã€‚ç†è§£å®ƒä»¬çš„ç‰©ç†ç»„ç»‡æ–¹å¼ï¼Œæ˜¯æŽŒæ¡MySQLæ€§èƒ½ä¼˜åŒ–çš„åŸºç¡€ã€‚

## æ•°æ®æ–‡ä»¶çš„å­˜å‚¨ç»“æž„

### æ˜¯ä»€ä¹ˆ

MySQL æ•°æ®åº“åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šçš„å­˜å‚¨ç»“æž„è¿œä¸æ­¢ç®€å•çš„æ•°æ®æ–‡ä»¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªç²¾å¿ƒç»„ç»‡çš„ä½“ç³»ï¼Œåæ˜ äº†æ•°æ®åº“å¼•æ“Žçš„åŠŸèƒ½å’Œæ•°æ®æŒä¹…åŒ–çš„éœ€æ±‚ã€‚

*   **db.opt (æ•°æ®åº“é€‰é¡¹æ–‡ä»¶)**ï¼šæ¯ä¸ªæ•°æ®åº“ç›®å½•ä¸‹æœ‰ä¸€ä¸ªï¼Œå­˜å‚¨è¯¥æ•°æ®åº“çš„é»˜è®¤å­—ç¬¦é›†ã€æŽ’åºè§„åˆ™ç­‰é…ç½®ä¿¡æ¯ã€‚
*   **tablename.frm (è¡¨ç»“æž„å®šä¹‰æ–‡ä»¶)**ï¼šæ¯ä¸ªè¡¨éƒ½æœ‰ä¸€ä¸ªï¼Œç‹¬ç«‹äºŽå­˜å‚¨å¼•æ“Žï¼Œè®°å½•è¡¨çš„åˆ—å®šä¹‰ã€æ•°æ®ç±»åž‹ã€ç´¢å¼•å®šä¹‰ç­‰å…ƒæ•°æ®ã€‚è¿™æ˜¯ SQL CREATE TABLE è¯­å¥çš„äº§ç‰©ã€‚
*   **InnoDB ç›¸å…³æ–‡ä»¶**ï¼š
    *   **tablename.ibd (è¡¨æ•°æ®æ–‡ä»¶)**ï¼šå½“ `innodb_file_per_table=ON` (é»˜è®¤è®¾ç½®) æ—¶ï¼Œæ¯ä¸ª InnoDB è¡¨çš„æ•°æ®å’Œæ‰€æœ‰ç´¢å¼•ï¼ˆåŒ…æ‹¬èšç°‡ç´¢å¼•å’Œæ‰€æœ‰è¾…åŠ©ç´¢å¼•ï¼‰éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ .ibd æ–‡ä»¶ä¸­ã€‚è¿™äº›æ–‡ä»¶å†…éƒ¨ä»¥é¡µ (Page) ä¸ºåŸºæœ¬å•ä½ï¼ˆé€šå¸¸ 16KBï¼‰è¿›è¡Œç®¡ç†ï¼ŒB+æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯¹åº”ç€ä¸€ä¸ªæˆ–å¤šä¸ªé¡µã€‚
    *   **ib_logfileX (Redo Log æ–‡ä»¶)**ï¼šè¿™äº›æ–‡ä»¶è®°å½•äº†æ‰€æœ‰å¯¹æ•°æ®è¿›è¡Œçš„ä¿®æ”¹æ“ä½œï¼ˆäº‹åŠ¡æ—¥å¿—ï¼‰ï¼Œç”¨äºŽä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ (Durability) å’Œå´©æºƒæ¢å¤ã€‚åœ¨ç³»ç»Ÿå´©æºƒåŽï¼ŒMySQL ä¼šé€šè¿‡è¿™äº›æ—¥å¿—å°†æœªæäº¤çš„äº‹åŠ¡å›žæ»šï¼Œå·²æäº¤ä½†æœªå†™å…¥ç£ç›˜çš„æ•°æ®é‡æ–°åº”ç”¨ã€‚
    *   **ibdataX (å…±äº«è¡¨ç©ºé—´æ–‡ä»¶)**ï¼šåœ¨ `innodb_file_per_table=OFF` æˆ–å­˜å‚¨ InnoDB ç³»ç»Ÿè¡¨ã€Undo Logã€åŒå†™ç¼“å†²åŒºç­‰ç³»ç»Ÿçº§æ•°æ®æ—¶ä½¿ç”¨ã€‚
*   **MyISAM ç›¸å…³æ–‡ä»¶**ï¼š
    *   **tablename.MYD (My Data æ–‡ä»¶)**ï¼šå­˜å‚¨ MyISAM è¡¨çš„å®žé™…æ•°æ®è¡Œï¼Œæ•°æ®æŒ‰æ’å…¥é¡ºåºç‰©ç†å­˜å‚¨ï¼Œæ— ç‰¹å®šæŽ’åºã€‚
    *   **tablename.MYI (My Index æ–‡ä»¶)**ï¼šå­˜å‚¨ MyISAM è¡¨çš„æ‰€æœ‰ç´¢å¼•ä¿¡æ¯ï¼Œæ˜¯ç‹¬ç«‹äºŽæ•°æ®æ–‡ä»¶å­˜å‚¨çš„ã€‚

### ä¸ºä»€ä¹ˆ

è¿™ç§æ–‡ä»¶ç»„ç»‡ç»“æž„æ˜¯ä¸ºäº†å®žçŽ°æ•°æ®åº“çš„æ ¸å¿ƒåŠŸèƒ½ã€æ€§èƒ½ä¼˜åŒ–å’Œå¥å£®æ€§ã€‚

*   **å…ƒæ•°æ®ä¸Žæ•°æ®åˆ†ç¦»**ï¼š`.frm` æ–‡ä»¶ç‹¬ç«‹å­˜å‚¨è¡¨ç»“æž„ï¼Œä½¿å¾—æ•°æ®åº“å¯ä»¥å¿«é€ŸåŠ è½½è¡¨å®šä¹‰ï¼Œå¹¶ä¸”å­˜å‚¨å¼•æ“Žå¯ä»¥çµæ´»é€‰æ‹©ã€‚
*   **é¡µå¼ç®¡ç†**ï¼šæ•°æ®åº“ç³»ç»Ÿä¸ç›´æŽ¥æ“ä½œæ–‡ä»¶ä¸­çš„å•ä¸ªå­—èŠ‚ï¼Œè€Œæ˜¯ä»¥å›ºå®šå¤§å°çš„"é¡µ"ä¸ºå•ä½è¿›è¡Œç£ç›˜ I/Oã€‚è¿™ä¸Žæ“ä½œç³»ç»Ÿå†…å­˜ç®¡ç†ä¸­çš„é¡µæ¦‚å¿µç›¸å‘¼åº”ï¼Œèƒ½é«˜æ•ˆåˆ©ç”¨ç£ç›˜çš„é¡ºåºè¯»å†™ç‰¹æ€§å’Œå±€éƒ¨æ€§åŽŸç†ï¼Œä¸€æ¬¡ I/O å°±èƒ½è¯»å–æ•´ä¸ªæ•°æ®å—ï¼Œå‡å°‘å¯»å€æ—¶é—´ã€‚è¿™æ˜¯å®žçŽ° B+ æ ‘é«˜æ•ˆæŸ¥æ‰¾çš„åŸºç¡€ã€‚
*   **InnoDB çš„äº‹åŠ¡ä¸Žæ¢å¤ä½“ç³»**ï¼š`ib_logfileX` (Redo Log) å’Œ Undo Log (åŒ…å«åœ¨ ibd/ibdata ä¸­) æ˜¯ InnoDB å®žçŽ° ACID äº‹åŠ¡å’Œå´©æºƒæ¢å¤çš„å…³é”®ã€‚Redo Log è®°å½•äº†æ•°æ®ä¿®æ”¹çš„ç‰©ç†æ“ä½œï¼Œç”¨äºŽå‰æ»šï¼ˆå°†å·²æäº¤ä½†æœªå†™å…¥ç£ç›˜çš„æ•°æ®åº”ç”¨å›žæ¥ï¼‰ï¼›Undo Log è®°å½•äº†äº‹åŠ¡çš„é€†æ“ä½œï¼Œç”¨äºŽå›žæ»šæœªå®Œæˆæˆ–éœ€è¦æ’¤é”€çš„äº‹åŠ¡ã€‚è¿™ç§è®¾è®¡åˆ†ç¦»äº†æ—¥å¿—è®°å½•ä¸Žå®žé™…æ•°æ®é¡µçš„å†™å…¥ï¼Œæé«˜äº†å†™æ“ä½œçš„æ€§èƒ½ï¼Œå¹¶ä¿è¯äº†åœ¨ç³»ç»Ÿæ•…éšœæ—¶æ•°æ®çš„å®Œæ•´æ€§ã€‚
*   **MyISAM çš„ç®€æ´ä¸Žå±€é™**ï¼šæ•°æ®å’Œç´¢å¼•çš„ç‰©ç†åˆ†ç¦»ï¼ˆ`.MYD` å’Œ `.MYI`ï¼‰ä½¿å¾— MyISAM çš„ç»“æž„ç›¸å¯¹ç®€å•ï¼Œé€‚åˆå¿«é€Ÿçš„å…¨è¡¨æ‰«æå’Œ `COUNT(*)` æ“ä½œã€‚ä½†è¿™ç§ç®€æ´æ€§ä¹Ÿå¸¦æ¥äº†æ— æ³•æ”¯æŒäº‹åŠ¡ã€è¡¨çº§é”å’Œä½Žå´©æºƒæ¢å¤èƒ½åŠ›çš„å±€é™æ€§ã€‚
*   **ç‹¬ç«‹è¡¨ç©ºé—´** (`.ibd` æ–‡ä»¶)ï¼šå°†æ¯ä¸ªè¡¨çš„æ•°æ®å’Œç´¢å¼•å­˜å‚¨åœ¨ç‹¬ç«‹çš„ `.ibd` æ–‡ä»¶ä¸­ï¼Œæ–¹ä¾¿äº†è¡¨çº§åˆ«çš„å¤‡ä»½ã€æ¢å¤ã€ç¢Žç‰‡æ•´ç†å’Œä¼ è¾“ï¼Œä¹Ÿä½¿å¾—å¯ä»¥æ›´å¥½åœ°è¿›è¡Œç©ºé—´ç®¡ç†å’Œå›žæ”¶ã€‚

## ç´¢å¼•

### æ˜¯ä»€ä¹ˆ

ç´¢å¼•æ˜¯æ•°æ®åº“ä¸­ç”¨äºŽæ˜¾è‘—åŠ é€Ÿæ•°æ®æ£€ç´¢çš„ç‰¹æ®Šæ•°æ®ç»“æž„ï¼Œå®ƒé€šè¿‡é¢„å…ˆæŽ’åºæˆ–ç»„ç»‡ç‰¹å®šåˆ—çš„æ•°æ®ï¼Œåˆ›å»ºæ•°æ®è®°å½•ä¸Žå­˜å‚¨ä½ç½®çš„æ˜ å°„ï¼Œä»Žè€Œå°†å…¨è¡¨æ‰«æï¼ˆçº¿æ€§æŸ¥æ‰¾ï¼‰è½¬å˜ä¸ºé«˜æ•ˆçš„ç´¢å¼•æŸ¥æ‰¾ã€‚ç´¢å¼•çš„åˆ†ç±»åŸºäºŽå…¶æ•°æ®ç»“æž„ã€ç‰©ç†å­˜å‚¨æ–¹å¼ã€å­—æ®µç‰¹æ€§å’Œå­—æ®µæ•°é‡ã€‚

**æŒ‰æ•°æ®ç»“æž„**ï¼š

*   **B+ æ ‘ç´¢å¼•**ï¼šæœ€å¸¸ç”¨å’Œé«˜æ•ˆçš„ç´¢å¼•ç»“æž„ï¼Œå¹¿æ³›åº”ç”¨äºŽå…³ç³»åž‹æ•°æ®åº“ã€‚å…¶ç‰¹ç‚¹æ˜¯å¤šè·¯å¹³è¡¡æ ‘ï¼Œæ‰€æœ‰æ•°æ®ï¼ˆæˆ–æ•°æ®æŒ‡é’ˆï¼‰ä»…å­˜åœ¨äºŽå¶å­èŠ‚ç‚¹ï¼Œå¶å­èŠ‚ç‚¹ä¹‹é—´é€šè¿‡åŒå‘é“¾è¡¨è¿žæŽ¥ï¼Œéžå¸¸é€‚åˆèŒƒå›´æŸ¥è¯¢ã€‚
*   **å“ˆå¸Œç´¢å¼•**ï¼šé€šè¿‡å“ˆå¸Œå‡½æ•°å°†é”®å€¼æ˜ å°„åˆ°å­˜å‚¨ä½ç½®ã€‚æŸ¥è¯¢é€Ÿåº¦ç†è®ºä¸Šä¸º O(1)ï¼Œä½†ä»…é€‚ç”¨äºŽç­‰å€¼æŸ¥è¯¢ï¼Œä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢å’Œæ¨¡ç³ŠåŒ¹é…ï¼Œä¸”å­˜åœ¨å“ˆå¸Œå†²çªé—®é¢˜ã€‚
*   **å…¨æ–‡ç´¢å¼•**ï¼šä¸“é—¨ç”¨äºŽæ–‡æœ¬å†…å®¹çš„æ¨¡ç³ŠæŸ¥è¯¢ï¼Œå¦‚ `LIKE '%keyword%'`ï¼ŒåŸºäºŽå€’æŽ’ç´¢å¼•å®žçŽ°ï¼Œèƒ½é«˜æ•ˆè¿›è¡Œå…³é”®è¯æœç´¢ã€‚

**æŒ‰ç‰©ç†å­˜å‚¨**ï¼š

*   **èšç°‡ç´¢å¼•** (Clustered Index)ï¼šæ•°æ®çš„ç‰©ç†å­˜å‚¨é¡ºåºä¸Žç´¢å¼•é”®å€¼é¡ºåºä¸€è‡´ã€‚åœ¨ InnoDB ä¸­ï¼Œé€šå¸¸æ˜¯ä¸»é”®ç´¢å¼•ã€‚å®ƒä¸ä»…åŒ…å«é”®å€¼ï¼Œå¶å­èŠ‚ç‚¹è¿˜ç›´æŽ¥å­˜å‚¨å®Œæ•´çš„è¡Œæ•°æ®ã€‚ä¸€ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªèšç°‡ç´¢å¼•ã€‚
*   **éžèšç°‡ç´¢å¼•** (Non-Clustered Index)ï¼šç´¢å¼•çš„ç‰©ç†å­˜å‚¨ç‹¬ç«‹äºŽæ•°æ®å­˜å‚¨ã€‚ç´¢å¼•å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯é”®å€¼å’ŒæŒ‡å‘å®žé™…æ•°æ®ä½ç½®çš„æŒ‡é’ˆï¼ˆåœ¨ InnoDB ä¸­æ˜¯ä¸»é”®å€¼ï¼Œåœ¨ MyISAM ä¸­æ˜¯ç‰©ç†åœ°å€åç§»é‡ï¼‰ã€‚ä¸€ä¸ªè¡¨å¯ä»¥æœ‰å¤šä¸ªéžèšç°‡ç´¢å¼•ï¼ˆè¾…åŠ©ç´¢å¼•ï¼‰ã€‚

**æŒ‰å­—æ®µç‰¹æ€§**ï¼š

*   **ä¸»é”®ç´¢å¼•** (Primary Key Index)ï¼šç‰¹æ®Šçš„å”¯ä¸€éžç©ºç´¢å¼•ï¼Œæ¯å¼ è¡¨æœ€å¤šä¸€ä¸ªã€‚
*   **å”¯ä¸€ç´¢å¼•** (Unique Index)ï¼šç´¢å¼•åˆ—çš„å€¼å¿…é¡»å”¯ä¸€ï¼Œä½†å¯ä»¥åŒ…å« NULLã€‚
*   **æ™®é€šç´¢å¼•** (Normal/Secondary Index)ï¼šæœ€åŸºæœ¬çš„ç´¢å¼•ï¼Œæ— é¢å¤–é™åˆ¶ã€‚
*   **å‰ç¼€ç´¢å¼•** (Prefix Index)ï¼šå¯¹å­—ç¬¦ä¸²ç±»åž‹åˆ—çš„éƒ¨åˆ†å‰ç¼€åˆ›å»ºç´¢å¼•ï¼ŒèŠ‚çœç©ºé—´ï¼Œä½†å¯èƒ½é™ä½ŽæŸ¥è¯¢ç²¾åº¦å’Œä¼˜åŒ–èƒ½åŠ›ã€‚

**æŒ‰å­—æ®µæ•°é‡**ï¼š

*   **å•åˆ—ç´¢å¼•** (Single-Column Index)ï¼šåªå¯¹è¡¨ä¸­çš„ä¸€ä¸ªåˆ—åˆ›å»ºç´¢å¼•ã€‚
*   **è”åˆç´¢å¼•** (Composite/Compound Index)ï¼šå¯¹è¡¨çš„å¤šä¸ªåˆ—ç»„åˆåˆ›å»ºç´¢å¼•ï¼Œéµå¾ª"æœ€å·¦å‰ç¼€åŽŸåˆ™"ã€‚

## B+æ ‘ç´¢å¼•çš„ç‰¹æ€§ä¸Žå®žçŽ°

B+ æ ‘æ˜¯ä¸€ç§é«˜åº¦ä¼˜åŒ–çš„ã€è‡ªå¹³è¡¡çš„å¤šè·¯æŸ¥æ‰¾æ ‘ï¼Œå®ƒæ˜¯å…³ç³»åž‹æ•°æ®åº“ï¼ˆå¦‚ MySQL InnoDBï¼‰ä¸­æœ€æ ¸å¿ƒå’Œå¹¿æ³›åº”ç”¨çš„ç´¢å¼•æ•°æ®ç»“æž„ã€‚å®ƒä»Ž B æ ‘æ¼”å˜è€Œæ¥ï¼Œä½†å¯¹å…¶è¿›è¡Œäº†å…³é”®æ”¹è¿›ï¼Œä»¥æ›´å¥½åœ°é€‚åº”ç£ç›˜å­˜å‚¨çš„ç‰¹æ€§å’Œæ•°æ®åº“æŸ¥è¯¢çš„éœ€æ±‚ã€‚

**ä¸»è¦ç‰¹æ€§**ï¼š

*   **å¤šè·¯åˆ†æ”¯**ï¼šæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼ˆé€šå¸¸æ•°ç™¾ç”šè‡³ä¸Šåƒä¸ªï¼‰ï¼Œè¿™ä½¿å¾—æ ‘çš„é«˜åº¦æžä½Žã€‚
*   **é”®å€¼å†—ä½™ä¸Žæ•°æ®å…¨åœ¨å¶å­èŠ‚ç‚¹**ï¼šéžå¶å­èŠ‚ç‚¹ï¼ˆå†…éƒ¨èŠ‚ç‚¹ï¼‰åªå­˜å‚¨é”®å€¼ï¼ˆç”¨äºŽå¯¼èˆªï¼‰å’ŒæŒ‡å‘å­èŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œä¸å­˜å‚¨å®žé™…çš„æ•°æ®è®°å½•æˆ–æ•°æ®æŒ‡é’ˆã€‚æ‰€æœ‰çœŸå®žçš„æ•°æ®è®°å½•æˆ–æŒ‡å‘æ•°æ®è®°å½•çš„æŒ‡é’ˆéƒ½åªå­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ä¸­ã€‚
*   **å¶å­èŠ‚ç‚¹é“¾è¡¨**ï¼šæ‰€æœ‰å¶å­èŠ‚ç‚¹æž„æˆä¸€ä¸ªæœ‰åºçš„åŒå‘é“¾è¡¨ã€‚è¿™ç§è®¾è®¡æžå¤§åœ°ä¾¿åˆ©äº†èŒƒå›´æŸ¥è¯¢å’Œå…¨è¡¨æ‰«æï¼ˆè™½ç„¶ä¸€èˆ¬ä¸ç”¨å…¨è¡¨æ‰«æç´¢å¼•ï¼‰ã€‚
*   **èŠ‚ç‚¹ä¸Žç£ç›˜é¡µåŒ¹é…**ï¼šæ¯ä¸ª B+ æ ‘èŠ‚ç‚¹çš„å¤§å°é€šå¸¸è®¾è®¡ä¸ºä¸Žæ•°æ®åº“çš„ç£ç›˜é¡µï¼ˆPageï¼‰å¤§å°ï¼ˆå¦‚ 16KBï¼‰ä¿æŒä¸€è‡´ã€‚


## ç´¢å¼•è¦†ç›– (Covering Index) æ˜¯å¦‚ä½•é¿å…å›žè¡¨çš„ï¼Ÿ

**æ˜¯ä»€ä¹ˆï¼š** ç´¢å¼•è¦†ç›–æ˜¯æŒ‡åœ¨ä¸€æ¬¡æŸ¥è¯¢ä¸­ï¼Œå¦‚æžœ**æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ—éƒ½åŒ…å«åœ¨è¾…åŠ©ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸­**ï¼ˆå³æŸ¥è¯¢çš„å­—æ®µå…¨éƒ¨æ˜¯ç´¢å¼•åˆ—æˆ–è€…ç´¢å¼•åˆ—çš„å­é›†ï¼‰ï¼Œé‚£ä¹ˆæ‰§è¡Œè®¡åˆ’å°±**æ— éœ€å›žè¡¨**åŽ»èšç°‡ç´¢å¼•ä¸­èŽ·å–å®Œæ•´çš„æ•°æ®è¡Œã€‚

**å¦‚ä½•é¿å…å›žè¡¨ï¼š**

*   å½“æŸ¥è¯¢åªæ¶‰åŠç´¢å¼•åˆ—æ—¶ï¼ŒMySQL åªéœ€è¦éåŽ†è¾…åŠ©ç´¢å¼•çš„ B+æ ‘ï¼Œå°±èƒ½ç›´æŽ¥ä»Ž**è¾…åŠ©ç´¢å¼•çš„å¶å­èŠ‚ç‚¹**ä¸­èŽ·å–æ‰€éœ€çš„æ‰€æœ‰æ•°æ®ã€‚
*   è¾…åŠ©ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸­å·²ç»åŒ…å«äº†**ç´¢å¼•åˆ—çš„å€¼å’Œä¸»é”®å€¼**ã€‚å¦‚æžœæŸ¥è¯¢çš„ `SELECT` åˆ—è¡¨åªåŒ…å«ç´¢å¼•åˆ—å’Œä¸»é”®åˆ—ï¼Œé‚£ä¹ˆåœ¨æ‰¾åˆ°è¾…åŠ©ç´¢å¼•çš„å¶å­èŠ‚ç‚¹åŽï¼Œå°±æ²¡æœ‰å¿…è¦å†é€šè¿‡ä¸»é”®å€¼åŽ»èšç°‡ç´¢å¼•ä¸­æŸ¥æ‰¾å®Œæ•´è¡Œæ•°æ®ï¼Œä»Žè€Œé¿å…äº†é¢å¤–çš„ç£ç›˜ I/O æ“ä½œï¼ˆå›žè¡¨ï¼‰ã€‚

**ç¤ºä¾‹ï¼š**
å‡è®¾è¡¨ `users` æœ‰ `id` (ä¸»é”®), `name`, `age`, `city` åˆ—ã€‚
æˆ‘ä»¬ä¸º `(name, age)` åˆ›å»ºäº†ä¸€ä¸ªè”åˆè¾…åŠ©ç´¢å¼• `idx_name_age`ã€‚

1.  **éœ€è¦å›žè¡¨çš„æŸ¥è¯¢ï¼š**
    `SELECT name, age, city FROM users WHERE name = 'Alice';`
    *   è¿™ä¸ªæŸ¥è¯¢éœ€è¦ `city` åˆ—ï¼Œè€Œ `city` ä¸åœ¨ `idx_name_age` ç´¢å¼•ä¸­ã€‚
    *   æ‰€ä»¥ï¼Œé€šè¿‡ `idx_name_age` æ‰¾åˆ° `name='Alice'` çš„è®°å½•åŽï¼Œè¿˜éœ€è¦**å›žè¡¨**åˆ°èšç°‡ç´¢å¼•ä¸­èŽ·å– `city` åˆ—çš„å€¼ã€‚

2.  **ç´¢å¼•è¦†ç›–çš„æŸ¥è¯¢ï¼ˆæ— éœ€å›žè¡¨ï¼‰ï¼š**
    `SELECT name, age FROM users WHERE name = 'Alice';`
    *   è¿™ä¸ªæŸ¥è¯¢åªæ¶‰åŠ `name` å’Œ `age` ä¸¤åˆ—ï¼Œè¿™ä¸¤åˆ—éƒ½åŒ…å«åœ¨ `idx_name_age` ç´¢å¼•ä¸­ã€‚
    *   MySQL å¯ä»¥ç›´æŽ¥é€šè¿‡éåŽ† `idx_name_age` ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ï¼ŒèŽ·å–åˆ° `name` å’Œ `age` çš„å€¼ï¼Œ**æ— éœ€å›žè¡¨**ã€‚
    *   `EXPLAIN` ç»“æžœä¸­å¯èƒ½ä¼šæ˜¾ç¤º `Extra` å­—æ®µæœ‰ `Using index`ã€‚

3.  **ç´¢å¼•è¦†ç›–çš„æŸ¥è¯¢ï¼ˆåŒ…å«ä¸»é”®ï¼Œä¹Ÿæ— éœ€å›žè¡¨ï¼‰ï¼š**
    `SELECT id, name, age FROM users WHERE name = 'Alice';`
    *   å³ä½¿æŸ¥è¯¢ä¸­åŒ…å«äº†ä¸»é”® `id`ï¼Œç”±äºŽè¾…åŠ©ç´¢å¼•çš„å¶å­èŠ‚ç‚¹æœ¬èº«å°±å­˜å‚¨äº†ä¸»é”®å€¼ï¼Œæ‰€ä»¥è¿™ä¸ªæŸ¥è¯¢ä¹Ÿå±žäºŽç´¢å¼•è¦†ç›–ï¼Œ**æ— éœ€å›žè¡¨**ã€‚

**ä¼˜ç‚¹ï¼š**

*   **å‡å°‘ç£ç›˜ I/Oï¼š** é¿å…äº†å›žè¡¨æ“ä½œï¼Œå‡å°‘äº†éšæœº I/Oï¼Œè¿™æ˜¯æ€§èƒ½æå‡çš„å…³é”®ã€‚
*   **æé«˜æŸ¥è¯¢æ•ˆçŽ‡ï¼š** æŸ¥è¯¢åªéœ€æ‰«æè¾…åŠ©ç´¢å¼•ï¼Œé€šå¸¸æ¯”æ‰«ææ•´ä¸ªèšç°‡ç´¢å¼•è¦å°å¾—å¤šï¼Œæ•ˆçŽ‡æ›´é«˜ã€‚

**å®žçŽ°ç´¢å¼•è¦†ç›–çš„ç­–ç•¥ï¼š**

*   æ ¹æ®å®žé™…æŸ¥è¯¢éœ€æ±‚ï¼Œåˆ›å»ºåŒ…å«æ‰€æœ‰æŸ¥è¯¢åˆ—çš„**è”åˆç´¢å¼•**ã€‚
*   `SELECT` è¯­å¥åªé€‰æ‹©éœ€è¦çš„åˆ—ï¼Œé¿å… `SELECT *`ã€‚


## æ—¥å¿—ç³»ç»Ÿ

> ðŸ”‘ **æ ¸å¿ƒè¦ç‚¹**ï¼šMySQLçš„æ—¥å¿—ç³»ç»Ÿç”±Redo Logã€Undo Logå’ŒBinlogä¸‰å¤§æ—¥å¿—ååŒå·¥ä½œï¼Œå…±åŒä¿è¯äº†äº‹åŠ¡çš„ACIDç‰¹æ€§å’Œæ•°æ®åº“çš„å¯é æ€§ã€‚

### æ˜¯ä»€ä¹ˆ

*   **Redo Log (é‡åšæ—¥å¿—)**ï¼šInnoDB ç‰¹æœ‰çš„**ç‰©ç†æ—¥å¿—**ã€‚è®°å½•äº†æ‰€æœ‰å¯¹æ•°æ®é¡µçš„ç‰©ç†ä¿®æ”¹ï¼Œå¦‚"åœ¨è¡¨ X çš„æ•°æ®é¡µ Y ä¸Šï¼Œåç§»é‡ Z å¤„çš„å€¼ä»Ž A å˜æˆäº† B"ã€‚è¿™äº›æ—¥å¿—ä»¥é¡ºåºè¿½åŠ çš„æ–¹å¼å†™å…¥ç£ç›˜ï¼Œå½¢æˆä¸€ä¸ªå¾ªçŽ¯å†™å…¥çš„æ—¥å¿—æ–‡ä»¶ã€‚
*   **Undo Log (å›žæ»šæ—¥å¿—)**ï¼šInnoDB ç‰¹æœ‰çš„**é€»è¾‘æ—¥å¿—**ã€‚è®°å½•äº†æ•°æ®åœ¨è¢«ä¿®æ”¹ä¹‹å‰çš„æ—§ç‰ˆæœ¬çš„å€¼ï¼Œç”¨äºŽäº‹åŠ¡å›žæ»šå’Œ MVCCã€‚
*   **Binlog (äºŒè¿›åˆ¶æ—¥å¿—)**ï¼šMySQL Server å±‚çš„**é€»è¾‘æ—¥å¿—**ã€‚è®°å½•äº†æ‰€æœ‰å¯¹æ•°æ®åº“çš„é€»è¾‘ä¿®æ”¹æ“ä½œï¼Œå¦‚"åœ¨è¡¨ X ä¸Šæ‰§è¡Œäº† INSERT æ“ä½œï¼Œæ’å…¥äº†å€¼ A"ã€‚

### ä¸ºä»€ä¹ˆ

*   **Redo Log (WAL æœºåˆ¶)**ï¼šä½¿ç”¨ **WAL (Write-Ahead Logging)** æœºåˆ¶ï¼Œè®©æ•°æ®åº“åœ¨äº‹åŠ¡æäº¤æ—¶ï¼Œå³ä½¿æ•°æ®è¿˜æ²¡æ¥å¾—åŠä»Žå†…å­˜åˆ·ç›˜å°±å‘ç”Ÿå´©æºƒï¼Œä¹Ÿèƒ½åœ¨é‡å¯åŽå°†è¿™äº›å·²æäº¤çš„äº‹åŠ¡é‡åšå›žæ¥ã€‚æ€è·¯æ˜¯å¯¹æ•°æ®åº“çš„ä»»ä½•æ•°æ®é¡µåšä¿®æ”¹ä¹‹å‰ï¼Œå¿…é¡»å…ˆå°†è¿™äº›ä¿®æ”¹æ“ä½œè®°å½•åˆ°æŒä¹…åŒ–çš„æ—¥å¿—å½“ä¸­ï¼Œå¹¶ä¸”è¿™äº›æ—¥å¿—è®°å½•è¦ä¼˜å…ˆäºŽå®žé™…æ•°æ®é¡µè¢«åˆ·æ–°åˆ°ç£ç›˜ã€‚
*   **Undo Log (äº‹åŠ¡å›žæ»šä¸Ž MVCC)**ï¼šæä¾›äº†äº‹åŠ¡å›žæ»šèƒ½åŠ›ï¼Œæ— è®ºäº‹åŠ¡æ‰§è¡Œåˆ°å“ªä¸ªé˜¶æ®µéƒ½èƒ½ç”¨ Undo Log å›žæ»šåˆ°ä¸Šä¸€ä¸ªçŠ¶æ€ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿæ˜¯ MVCC å®žçŽ°å¤šç‰ˆæœ¬çš„åŸºç¡€ï¼Œä¸ºè¯»æ“ä½œæä¾›åŽ†å²æ•°æ®å¿«ç…§ã€‚
*   **Binlog (æ•°æ®æ¢å¤ä¸Žä¸»ä»Žå¤åˆ¶)**ï¼šä½¿å¾—æ•°æ®å¯ä»¥è¿›è¡ŒæŸä¸€ä¸ªæ—¶é—´ç‚¹çš„æ¢å¤ï¼Œå‡ºçŽ°é”™è¯¯æ“ä½œå¯ä»¥é€šè¿‡ç²¾ç¡®åˆ°æŸä¸ªæ—¶é—´çš„æ•°æ®æ¢å¤ã€‚åŒæ—¶ï¼ŒBinlog ä¹Ÿå¯ä»¥ç”¨äºŽä¸»ä»Žå¤åˆ¶ï¼Œä¸»åº“çš„æ‰€æœ‰æ“ä½œéƒ½ä¼šè®°å½•åˆ° Binlog ä¸­ï¼Œä»Žåº“å¯ä»¥é€šè¿‡è¯»å–ä¸»åº“çš„ Binlog æ¥è¿›è¡Œæ•°æ®åŒæ­¥ã€‚



## äº‹åŠ¡

> ðŸ”‘ **æ ¸å¿ƒè¦ç‚¹**ï¼šäº‹åŠ¡æ˜¯æ•°æ®åº“çš„åŸºç¡€åŠŸèƒ½å•å…ƒï¼Œé€šè¿‡ACIDç‰¹æ€§ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå¯é æ€§ã€‚ç†è§£äº‹åŠ¡çš„ç‰¹æ€§å’Œå®žçŽ°æœºåˆ¶ï¼Œæ˜¯æ·±å…¥ç†è§£MySQLçš„å…³é”®ã€‚

### æ˜¯ä»€ä¹ˆ

äº‹åŠ¡æ˜¯ä¸€ä¸ªæ•°æ®åº“æ“ä½œçš„é€»è¾‘å•å…ƒï¼Œå®ƒç”±ä¸€ç³»åˆ—çš„æ•°æ®åº“æ“ä½œç»„æˆï¼Œè¿™äº›æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚äº‹åŠ¡çš„å››ä¸ªç‰¹æ€§è¢«ç§°ä¸º **ACID** ç‰¹æ€§ï¼š

*   **åŽŸå­æ€§ (Atomicity)**ï¼šäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨æ’¤é”€ã€‚å³ä½¿åœ¨ç³»ç»Ÿå´©æºƒæˆ–é”™è¯¯å‘ç”Ÿæ—¶ï¼Œä¹Ÿèƒ½ä¿è¯äº‹åŠ¡çš„å®Œæ•´æ€§ã€‚
*   **ä¸€è‡´æ€§ (Consistency)**ï¼šäº‹åŠ¡æ‰§è¡Œå‰åŽï¼Œæ•°æ®åº“çš„çŠ¶æ€å¿…é¡»ä¿æŒä¸€è‡´ã€‚å³äº‹åŠ¡çš„æ‰§è¡Œä¸ä¼šç ´åæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸã€‚
*   **éš”ç¦»æ€§ (Isolation)**ï¼šå¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œæ—¶ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½åº”è¯¥åƒæ˜¯ç‹¬ç«‹æ‰§è¡Œçš„ï¼Œäº’ä¸å¹²æ‰°ã€‚å³ä½¿å¤šä¸ªäº‹åŠ¡åŒæ—¶æ“ä½œåŒä¸€æ•°æ®ï¼Œä¹Ÿä¸ä¼šå½±å“å„è‡ªçš„ç»“æžœã€‚
*   **æŒä¹…æ€§ (Durability)**ï¼šä¸€æ—¦äº‹åŠ¡æäº¤ï¼Œå…¶ç»“æžœæ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³ä½¿ç³»ç»Ÿå´©æºƒæˆ–é‡å¯ï¼Œå·²æäº¤çš„äº‹åŠ¡ç»“æžœä¹Ÿä¸ä¼šä¸¢å¤±ã€‚

### ä¸ºä»€ä¹ˆ

*   **é˜²æ­¢éƒ¨åˆ†æ›´æ–°**ï¼šæœ‰äº›æ“ä½œï¼Œæ¯”å¦‚â€œæ‰£æ¬¾â€å’Œâ€œæ‰£å‡åº“å­˜â€ï¼Œè¿™ä¸¤ä¸ªæ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ï¼Œä¸èƒ½å‡ºçŽ°æ‰£æ¬¾æˆåŠŸä½†åº“å­˜æ²¡æœ‰å‡å°‘çš„æƒ…å†µã€‚
*   **é˜²æ­¢å¹¶å‘è®¿é—®ä¸‹çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜**ï¼šæ¯”å¦‚ä¸¤ä¸ªç”¨æˆ·åŒæ—¶è´­ä¹°åŒä¸€ä»¶å•†å“ï¼Œå¯èƒ½ä¼šå¯¼è‡´åº“å­˜è¶…å–ã€‚
*   **ä¿è¯æ•°æ®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§**ï¼šç¡®ä¿æ•°æ®åº“åœ¨ä»»ä½•æ—¶å€™éƒ½å¤„äºŽä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€ã€‚


# å¹¶å‘é—®é¢˜ä¸Žäº‹åŠ¡éš”ç¦»çº§åˆ«

> ðŸ”‘ **æ ¸å¿ƒè¦ç‚¹**ï¼šå¹¶å‘è®¿é—®å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œæ•°æ®åº“é€šè¿‡äº‹åŠ¡éš”ç¦»çº§åˆ«æ¥æŽ§åˆ¶å¹¶å‘äº‹åŠ¡é—´çš„å¯è§æ€§ï¼Œåœ¨ä¸€è‡´æ€§å’Œæ€§èƒ½ä¹‹é—´å¯»æ±‚å¹³è¡¡ã€‚

## å¯èƒ½å­˜åœ¨çš„å¹¶å‘é—®é¢˜

### æ˜¯ä»€ä¹ˆ

*   **è„è¯» (Dirty Read)**ï¼š
    *   **å®šä¹‰**ï¼šä¸€ä¸ªäº‹åŠ¡ï¼ˆT1ï¼‰è¯»å–äº†å¦ä¸€ä¸ª**å°šæœªæäº¤çš„äº‹åŠ¡ï¼ˆT2ï¼‰**å¯¹æ•°æ®çš„ä¿®æ”¹ã€‚
    *   **è¡¨çŽ°**ï¼šå¦‚æžœäº‹åŠ¡ T2 éšåŽå› ä¸ºæŸç§åŽŸå› å›žæ»š (Rollback)ï¼Œé‚£ä¹ˆäº‹åŠ¡ T1 è¯»å–åˆ°çš„æ•°æ®å°±æ˜¯æ— æ•ˆçš„ã€ä¸å­˜åœ¨çš„"è„"æ•°æ®ã€‚
*   **ä¸å¯é‡å¤è¯» (Non-Repeatable Read)**ï¼š
    *   **å®šä¹‰**ï¼šä¸€ä¸ªäº‹åŠ¡ï¼ˆT1ï¼‰åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–åŒä¸€è¡Œæ•°æ®ï¼Œä½†åœ¨ä¸¤æ¬¡è¯»å–ä¹‹é—´ï¼Œå¦ä¸€ä¸ª**å·²æäº¤çš„äº‹åŠ¡ï¼ˆT2ï¼‰**ä¿®æ”¹äº†è¿™è¡Œæ•°æ®ã€‚
    *   **è¡¨çŽ°**ï¼šäº‹åŠ¡ T1 ä¸¤æ¬¡è¯»å–åˆ°çš„åŒä¸€è¡Œæ•°æ®çš„å€¼ä¸åŒï¼Œç ´åäº†å…¶å¯¹æ•°æ®çš„ä¸€è‡´æ€§è§†å›¾ã€‚
*   **å¹»è¯» (Phantom Read)**ï¼š
    *   **å®šä¹‰**ï¼šä¸€ä¸ªäº‹åŠ¡ï¼ˆT1ï¼‰åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡æ‰§è¡ŒæŸ¥è¯¢æ¡ä»¶ç›¸åŒçš„èŒƒå›´æŸ¥è¯¢ï¼Œä½†åœ¨ä¸¤æ¬¡æŸ¥è¯¢ä¹‹é—´ï¼Œå¦ä¸€ä¸ª**å·²æäº¤çš„äº‹åŠ¡ï¼ˆT2ï¼‰**æ’å…¥äº†ç¬¦åˆ T1 æŸ¥è¯¢æ¡ä»¶çš„æ–°æ•°æ®è¡Œã€‚
    *   **è¡¨çŽ°**ï¼šäº‹åŠ¡ T1 ç¬¬äºŒæ¬¡æŸ¥è¯¢æ—¶å‘çŽ°ç»“æžœé›†çš„è¡Œæ•°å¢žåŠ äº†ï¼Œå°±å¥½åƒå‡ºçŽ°äº†"å¹»å½±"ä¸€æ ·ã€‚

### ä¸ºä»€ä¹ˆ

1.  **äº‹åŠ¡çš„å¹¶å‘æ€§å’Œäº¤é”™æ‰§è¡Œ (Interleaving)**ï¼š
    *   **æ ¹æœ¬åŽŸå› **ï¼šæ•°æ®åº“ä¸ºäº†æé«˜åžåé‡ï¼Œä¸ä¼šè®©äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œè€Œæ˜¯äº¤é”™æ‰§è¡Œã€‚å½“ä¸€ä¸ªäº‹åŠ¡çš„æ“ä½œä¾èµ–äºŽå¦ä¸€ä¸ªäº‹åŠ¡çš„ä¸­é—´çŠ¶æ€æ—¶ï¼Œå°±ä¼šå¯¼è‡´ä¸ä¸€è‡´ã€‚
2.  **æ•°æ®ä¿®æ”¹çš„å¯è§æ€§ (Visibility)**ï¼š
    *   **è„è¯»**ï¼šå› ä¸ºéš”ç¦»æœºåˆ¶ä¸è¶³ï¼Œä¸€ä¸ªäº‹åŠ¡æå‰çœ‹åˆ°äº†å¦ä¸€ä¸ªäº‹åŠ¡å°šæœª"å®šè®º"çš„ä¿®æ”¹ã€‚
    *   **ä¸å¯é‡å¤è¯»**ï¼šå› ä¸ºäº‹åŠ¡æ— æ³•é”å®šè‡ªå·±è¯»å–è¿‡çš„æ•°æ®è¡Œï¼Œå¯¼è‡´å…¶ä»–å·²æäº¤äº‹åŠ¡çš„ä¿®æ”¹å¯¹æœ¬äº‹åŠ¡å¯è§ã€‚
    *   **å¹»è¯»**ï¼šå› ä¸ºè¡Œçº§é”æ— æ³•é”å®šä¸€ä¸ª"ä¸å­˜åœ¨çš„è¡Œ"æˆ–ä¸€ä¸ªæ•°æ®èŒƒå›´ï¼Œå¯¼è‡´å…¶ä»–äº‹åŠ¡å¯ä»¥æ’å…¥ç¬¦åˆèŒƒå›´æŸ¥è¯¢çš„æ–°è¡Œã€‚
3.  **ç¼ºä¹è¶³å¤Ÿçš„å¹¶å‘æŽ§åˆ¶æ‰‹æ®µ**ï¼š
    *   è¿™äº›é—®é¢˜æœ¬è´¨ä¸Šéƒ½æ˜¯ç”±äºŽåœ¨å¹¶å‘æ‰§è¡Œæ—¶ï¼Œæ•°æ®åº“æœªèƒ½æä¾›è¶³å¤Ÿçš„éš”ç¦»çº§åˆ«æ¥é˜²æ­¢äº‹åŠ¡ä¹‹é—´çš„ç›¸äº’å½±å“ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæ•°æ®åº“å¼•å…¥äº†**é”æœºåˆ¶**å’Œ**å¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶ï¼ˆMVCCï¼‰**ã€‚

---

## äº‹åŠ¡çš„éš”ç¦»çº§åˆ«

> ðŸ”‘ **æ ¸å¿ƒè¦ç‚¹**ï¼šäº‹åŠ¡éš”ç¦»çº§åˆ«å®šä¹‰äº†å¹¶å‘äº‹åŠ¡ä¹‹é—´çš„å¯è§æ€§å’Œå½±å“ç¨‹åº¦ï¼Œæ˜¯æ•°æ®åº“åœ¨ä¸€è‡´æ€§å’Œæ€§èƒ½ä¹‹é—´çš„æƒè¡¡æœºåˆ¶ã€‚

### æ˜¯ä»€ä¹ˆ

**äº‹åŠ¡éš”ç¦»çº§åˆ«**æ˜¯æ•°æ®åº“ç³»ç»Ÿä¸ºæŽ§åˆ¶å¤šä¸ªå¹¶å‘äº‹åŠ¡ä¹‹é—´ç›¸äº’å½±å“ç¨‹åº¦è€Œæä¾›çš„ä¸€ç»„æ ‡å‡†ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªäº‹åŠ¡åœ¨å¹¶å‘æ‰§è¡Œæ—¶ï¼Œå¯¹å…¶ä»–äº‹åŠ¡æ‰€åšä¿®æ”¹çš„**å¯è§æ€§**å’Œæ•°æ®å¯èƒ½å—åˆ°å…¶ä»–å¹¶å‘äº‹åŠ¡**å¹²æ‰°çš„ç¨‹åº¦**ã€‚

### å››ç§æ ‡å‡†éš”ç¦»çº§åˆ«ä¸Žå®žçŽ°æœºåˆ¶

| éš”ç¦»çº§åˆ«          | è„è¯»   | ä¸å¯é‡å¤è¯» | å¹»è¯»       | å¹¶å‘æ€§èƒ½ | ä¸»è¦å®žçŽ°æœºåˆ¶ï¼ˆInnoDBï¼‰                                       |
| :---------------- | :----- | :--------- | :--------- | :------- | :----------------------------------------------------------- |
| **è¯»æœªæäº¤**      | å…è®¸   | å…è®¸       | å…è®¸       | æœ€é«˜     | æ— é”ï¼Œç›´æŽ¥è¯»æœ€æ–°æ•°æ®                                         |
| **è¯»å·²æäº¤**      | é¿å…   | å…è®¸       | å…è®¸       | è¾ƒé«˜     | æ¯æ¬¡è¯»ç”Ÿæˆæ–° ReadViewï¼Œå†™æ“ä½œåŠ è¡Œçº§æŽ’ä»–é”                    |
| **å¯é‡å¤è¯»**      | é¿å…   | é¿å…       | **é¿å…**   | ä¸­ç­‰     | äº‹åŠ¡å¼€å§‹æ—¶ç”Ÿæˆ ReadViewï¼Œç»“åˆ**é—´éš™é”/ä¸´é”®é”**é˜²æ­¢å¹»è¯»       |
| **ä¸²è¡ŒåŒ–**        | é¿å…   | é¿å…       | é¿å…       | æœ€ä½Ž     | å¼ºåˆ¶ä¸²è¡Œæ‰§è¡Œï¼Œè¯»åŠ å…±äº«é”ï¼Œå†™åŠ æŽ’ä»–é”                         |


# InnoDB çš„å¹¶å‘æŽ§åˆ¶æœºåˆ¶

> ðŸ”‘ **æ ¸å¿ƒè¦ç‚¹**ï¼šInnoDBé€šè¿‡é”æœºåˆ¶å’ŒMVCCä¸¤ç§æ–¹å¼å®žçŽ°å¹¶å‘æŽ§åˆ¶ã€‚é”æœºåˆ¶ä¸»è¦ç”¨äºŽå†™æ“ä½œçš„äº’æ–¥ï¼Œè€ŒMVCCåˆ™æä¾›äº†é«˜æ•ˆçš„è¯»å†™å¹¶å‘æ–¹æ¡ˆã€‚

## InnoDB çš„é”æœºåˆ¶

### æ˜¯ä»€ä¹ˆ

*   **è¡Œçº§é” (Record Lock)**ï¼šInnoDB çš„æœ€ç»†ç²’åº¦é”ï¼Œé”å®šå…·ä½“çš„è¡Œè®°å½•ã€‚åˆ†ä¸ºå…±äº«é”ï¼ˆSé”ï¼‰å’ŒæŽ’ä»–é”ï¼ˆXé”ï¼‰ã€‚
*   **æ„å‘é” (Intention Lock)**ï¼šè¡¨çº§é”ï¼Œç›®çš„æ˜¯è¡¨ç¤ºäº‹åŠ¡å³å°†æˆ–å·²ç»å¯¹æŸå‡ è¡ŒåŠ é”ï¼Œç”¨äºŽè§£å†³è¡Œé”å’Œè¡¨é”çš„å…¼å®¹æ€§é—®é¢˜ã€‚
*   **é—´éš™é” (Gap Lock)**ï¼šé”å®šä¸€ä¸ª**ç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™**ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¿™ä¸ªé—´éš™ä¸­æ’å…¥æ•°æ®ï¼Œç”¨äºŽåœ¨ RR éš”ç¦»çº§åˆ«ä¸‹é˜²æ­¢å¹»è¯»ã€‚
*   **ä¸´é”®é” (Next-Key Lock)**ï¼š**è¡Œé”å’Œé—´éš™é”çš„ç»„åˆ**ï¼Œé”å®šä¸€ä¸ªå·¦å¼€å³é—­çš„åŒºé—´ï¼Œæ˜¯ RR éš”ç¦»çº§åˆ«ä¸‹é˜²æ­¢å¹»è¯»çš„é»˜è®¤ç­–ç•¥ã€‚

### ä¸ºä»€ä¹ˆ

*   **å®žçŽ°é«˜å¹¶å‘æ€§ (Row-Level Locking)**ï¼šé€šè¿‡è¡Œçº§é”ï¼ŒInnoDB å…è®¸ä¸åŒçš„äº‹åŠ¡åŒæ—¶ä¿®æ”¹è¡¨ä¸­ä¸åŒçš„è¡Œï¼Œæœ€å¤§åŒ–äº†å¹¶å‘åº¦ã€‚
*   **ä¿è¯äº‹åŠ¡éš”ç¦»æ€§ (Isolation Levels)**ï¼šé€šè¿‡ä¸åŒçš„é”ç­–ç•¥ï¼ˆè¡Œé”ã€é—´éš™é”ã€ä¸´é”®é”ï¼‰æ¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ã€‚
*   **è§£å†³é”å‡çº§é—®é¢˜ (Intention Locks)**ï¼šæ„å‘é”ä½œä¸ºä¸€ç§è¡¨çº§ä¿¡å·ï¼Œé¿å…äº†åœ¨èŽ·å–è¡¨é”æ—¶éœ€è¦æ‰«æå…¨è¡¨æ£€æŸ¥è¡Œé”çš„å·¨å¤§å¼€é”€ã€‚
*   **æ”¯æŒ MVCC (Multi-Version Concurrency Control)**ï¼šInnoDB ç»“åˆäº†é”å’Œ MVCCã€‚å¯¹äºŽæ™®é€šè¯»æ“ä½œï¼Œé€šå¸¸ä¸åŠ é”ï¼Œè€Œæ˜¯é€šè¿‡ Undo Log è¯»å–æ•°æ®çš„åŽ†å²ç‰ˆæœ¬å¿«ç…§ï¼Œå®žçŽ°äº†è¯»å†™ä¸é˜»å¡žã€‚


## é”çš„ä½“çŽ°ä¸Žåœºæ™¯

### é—´éš™é” (Gap Lock)

*   **æ˜¯ä»€ä¹ˆ**ï¼šé”å®š**ç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™**ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨è¿™ä¸ªä¸å­˜åœ¨çš„è®°å½•èŒƒå›´ä¸­æ’å…¥æ–°æ•°æ®ã€‚
*   **é€‚ç”¨åœºæ™¯**ï¼šä¸»è¦ç”¨äºŽ RR éš”ç¦»çº§åˆ«ä¸‹çš„èŒƒå›´æŸ¥è¯¢å’Œæ›´æ–°ï¼Œä»¥é˜²æ­¢å¹»è¯»ã€‚

### ä¸´é”®é” (Next-Key Lock)

*   **æ˜¯ä»€ä¹ˆ**ï¼š**è¡Œé” + é—´éš™é”**çš„ç»„åˆï¼Œé”å®šä¸€ä¸ªè®°å½•æœ¬èº«ä»¥åŠå®ƒä¹‹å‰çš„é—´éš™ã€‚
*   **é€‚ç”¨åœºæ™¯**ï¼šInnoDB åœ¨ RR éš”ç¦»çº§åˆ«ä¸‹çš„**é»˜è®¤é”è¡Œä¸º**ï¼Œç”¨äºŽ `UPDATE`ã€`DELETE` å’Œ `SELECT ... FOR UPDATE` ç­‰æ“ä½œï¼Œä»¥åŒæ—¶é˜²æ­¢ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ã€‚


## æ­»é”

### æ­»é”æ£€æµ‹çš„åŽŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

1.  **ç­‰å¾…å›¾ (Wait-for Graph) æž„å»º**ï¼šInnoDB åœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªæœ‰å‘å›¾ï¼ŒèŠ‚ç‚¹ä»£è¡¨äº‹åŠ¡ï¼Œè¾¹ä»£è¡¨é”ç­‰å¾…å…³ç³»ï¼ˆA ç­‰å¾… Bï¼Œåˆ™ A->Bï¼‰ã€‚
2.  **å‘¨æœŸæ£€æµ‹**ï¼šæ­»é”æ£€æµ‹å™¨å‘¨æœŸæ€§åœ°æ£€æŸ¥ç­‰å¾…å›¾ä¸­æ˜¯å¦å­˜åœ¨**çŽ¯è·¯ (Cycle)**ã€‚å¦‚æžœå­˜åœ¨çŽ¯è·¯ï¼Œå°±è¯´æ˜Žå‘ç”Ÿäº†æ­»é”ã€‚
3.  **å›žæ»š"ç‰ºç‰²è€…"**ï¼šä¸€æ—¦æ£€æµ‹åˆ°çŽ¯è·¯ï¼ŒInnoDB ä¼šé€‰æ‹©ä¸€ä¸ªå›žæ»šæˆæœ¬æœ€å°çš„äº‹åŠ¡è¿›è¡Œå›žæ»šï¼Œé‡Šæ”¾å…¶æŒæœ‰çš„é”ï¼Œä»Žè€Œæ‰“ç ´æ­»é”ã€‚

### å¦‚ä½•é¿å…æ­»é”ï¼Ÿ

1.  **ä»¥å›ºå®šçš„é¡ºåºè®¿é—®èµ„æº**ï¼šè¿™æ˜¯æœ€æœ‰æ•ˆçš„æ–¹æ³•ä¹‹ä¸€ã€‚
2.  **æ‰¹é‡æ“ä½œï¼Œå‡å°‘é”çš„æŒæœ‰æ—¶é—´**ï¼šå°†éœ€è¦é”å®šçš„æ“ä½œé›†ä¸­èµ·æ¥ï¼Œä¸€æ¬¡æ€§å®Œæˆã€‚
3.  **å¤§äº‹åŠ¡æ‹†å°äº‹åŠ¡**ï¼šå‡å°‘å•ä¸ªäº‹åŠ¡æŒæœ‰é”çš„æ—¶é—´å’Œèµ„æºèŒƒå›´ã€‚
4.  **ä¸ºæŸ¥è¯¢å¢žåŠ åˆé€‚çš„ç´¢å¼•**ï¼šå‡å°‘æ‰«æè¡Œæ•°ï¼Œä»Žè€Œå‡å°‘åŠ é”èŒƒå›´ã€‚
5.  **é™ä½Žéš”ç¦»çº§åˆ«ï¼ˆæ…Žç”¨ï¼‰**ï¼šè™½ç„¶å¯ä»¥é™ä½Žæ­»é”æ¦‚çŽ‡ï¼Œä½†ä¼šå¼•å…¥å…¶ä»–å¹¶å‘é—®é¢˜ã€‚


## MVCC (å¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶)

### æ˜¯ä»€ä¹ˆ & ä¸ºä»€ä¹ˆ

MVCC æ˜¯ä¸€ç§**è¯»ä¸åŠ é”ã€å†™ä¸é˜»å¡ž**çš„å¹¶å‘æŽ§åˆ¶æ–¹æ¡ˆï¼Œé€šè¿‡ä¸ºæ¯æ¡è®°å½•ä¿å­˜å¤šä¸ªåŽ†å²ç‰ˆæœ¬æ¥å®žçŽ°ã€‚å½“ä¸€ä¸ªæ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œå®ƒä¸ç›´æŽ¥è¦†ç›–æ—§æ•°æ®ï¼Œè€Œæ˜¯åœ¨ Undo Log ä¸­å‚¨å­˜æ—§ç‰ˆæœ¬ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬ã€‚è¿™æžå¤§åœ°æå‡äº†æ•°æ®åº“çš„å¹¶å‘æ€§èƒ½ã€‚

### MVCC çš„å·¥ä½œåŽŸç†ï¼šç‰ˆæœ¬é“¾ä¸Ž ReadView

1.  **ç‰ˆæœ¬é“¾ (Version Chain)**ï¼š
    *   InnoDB ä¸ºæ¯è¡Œæ•°æ®æ·»åŠ äº† `DB_TRX_ID`ï¼ˆäº‹åŠ¡IDï¼‰å’Œ `DB_ROLL_PTR`ï¼ˆå›žæ»šæŒ‡é’ˆï¼‰ç­‰éšè—åˆ—ã€‚
    *   æ¯æ¬¡ä¿®æ”¹æ•°æ®æ—¶ï¼Œæ—§ç‰ˆæœ¬è¢«å†™å…¥ Undo Logï¼Œå¹¶é€šè¿‡ `DB_ROLL_PTR` ä¸²è”èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªä»Žæœ€æ–°åˆ°æœ€æ—§çš„ç‰ˆæœ¬é“¾ã€‚

2.  **ReadView (ä¸€è‡´æ€§è¯»è§†å›¾)**ï¼š
    *   å½“äº‹åŠ¡æ‰§è¡Œå¿«ç…§è¯»ï¼ˆæ™®é€š `SELECT`ï¼‰æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ª ReadViewï¼Œå®ƒè®°å½•äº†å½“å‰æ´»è·ƒçš„äº‹åŠ¡åˆ—è¡¨ã€‚
    *   **å¯è§æ€§åˆ¤æ–­**ï¼šå½“è¯»å–ä¸€è¡Œæ•°æ®æ—¶ï¼Œä¼šç”¨è¯¥è¡Œå½“å‰çš„ `DB_TRX_ID` ä¸Ž ReadView è¿›è¡Œæ¯”è¾ƒï¼Œåˆ¤æ–­è¯¥ç‰ˆæœ¬æ˜¯å¦å¯è§ã€‚å¦‚æžœä¸å¯è§ï¼Œåˆ™æ²¿ç€ç‰ˆæœ¬é“¾ï¼ˆé€šè¿‡ `DB_ROLL_PTR`ï¼‰å¯»æ‰¾ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå¯è§çš„ç‰ˆæœ¬ä¸ºæ­¢ã€‚

3.  **éš”ç¦»çº§åˆ«ä¸Ž ReadView çš„å…³ç³»**ï¼š
    *   **è¯»å·²æäº¤ (RC)**ï¼š**æ¯æ¬¡ `SELECT` è¯­å¥æ‰§è¡Œæ—¶éƒ½ä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ª ReadView**ã€‚
    *   **å¯é‡å¤è¯» (RR)**ï¼š**äº‹åŠ¡å¼€å§‹æ—¶åªç”Ÿæˆä¸€ä¸ª ReadViewï¼Œå¹¶åœ¨æ•´ä¸ªäº‹åŠ¡ç”Ÿå‘½å‘¨æœŸå†…éƒ½ä½¿ç”¨è¿™ä¸ª ReadView**ã€‚

## å®žæˆ˜æŽ’æŸ¥ï¼šå½“æŸ¥è¯¢èµ°äº†ç´¢å¼•ä¾ç„¶å¾ˆæ…¢

> ðŸ”‘ **æ ¸å¿ƒè¦ç‚¹**ï¼šå½“â€œåŠ ç´¢å¼•â€è¿™ä¸€æ ‡å‡†ç­”æ¡ˆå¤±æ•ˆæ—¶ï¼Œéœ€è¦ä»Žç´¢å¼•è´¨é‡ã€æŸ¥è¯¢å†™æ³•ã€æ•°æ®åˆ†å¸ƒå’Œç³»ç»Ÿè´Ÿè½½ç­‰å¤šä¸ªç»´åº¦è¿›è¡Œç³»ç»Ÿæ€§æŽ’æŸ¥ã€‚


### ç¬¬ 1 æ­¥ï¼šæ·±å…¥åˆ†æž `EXPLAIN` çš„è¾“å‡º

è™½ç„¶æŸ¥è¯¢èµ°äº†ç´¢å¼•ï¼ˆ`key` åˆ—ä¸ä¸º NULLï¼‰ï¼Œä½†æˆ‘ä»¬ä»éœ€æ·±å…¥æŒ–æŽ˜ `EXPLAIN` çš„å…¶ä»–åˆ—ï¼Œå®ƒä»¬éšè—äº†æ€§èƒ½é—®é¢˜çš„å…³é”®çº¿ç´¢ã€‚

#### 1.1 æ£€æŸ¥ `rows` åˆ—ï¼šé¢„ä¼°æ‰«æè¡Œæ•°

*   **é—®é¢˜**ï¼š`key` åˆ—æœ‰å€¼ï¼Œä½† `rows` åˆ—çš„å€¼æ˜¯å¦ä¾ç„¶éžå¸¸å¤§ï¼ˆå¦‚ä¸Šä¸‡ã€ç”šè‡³ç™¾ä¸‡ï¼‰ï¼Ÿ
*   **åŽŸå› **ï¼šè¿™é€šå¸¸æ„å‘³ç€ç´¢å¼•çš„**é€‰æ‹©æ€§ (Selectivity) å¤ªä½Ž**ã€‚ä¼˜åŒ–å™¨è®¤ä¸ºèµ°ç´¢å¼•çš„æˆæœ¬ï¼ˆæ‰«æå¤§é‡ç´¢å¼•é¡µ + å›žè¡¨ï¼‰å¯èƒ½ä¸æ¯”å…¨è¡¨æ‰«æä½Žå¤šå°‘ï¼Œæˆ–è€…è™½ç„¶èµ°äº†ç´¢å¼•ï¼Œä½†ä»ç„¶éœ€è¦å¤„ç†å¤§é‡çš„æ•°æ®ã€‚
*   **ç¤ºä¾‹**ï¼šä¸€ä¸ª `users` è¡¨æœ‰ 1000 ä¸‡è¡Œæ•°æ®ï¼Œä¸º `status` åˆ—ï¼ˆå€¼ä¸º 0, 1, 2ï¼‰åˆ›å»ºäº†ç´¢å¼• `idx_status`ã€‚
    ```sql
    EXPLAIN SELECT * FROM users WHERE status = 1;
    ```
    è™½ç„¶ `key` ä¼šæ˜¾ç¤º `idx_status`ï¼Œä½† `rows` å¯èƒ½ä¼šæ˜¾ç¤º 300 ä¸‡ã€‚è¿™æ„å‘³ç€MySQLéœ€è¦æ‰«æ 300 ä¸‡ä¸ªç´¢å¼•æ¡ç›®ï¼Œå¹¶è¿›è¡Œ 300 ä¸‡æ¬¡å›žè¡¨ï¼Œè¿™å¿…ç„¶å¾ˆæ…¢ã€‚
*   **å¯¹ç­–**ï¼š
    *   **è¯„ä¼°ç´¢å¼•é€‰æ‹©æ€§**ï¼šå¯¹äºŽåŸºæ•°ï¼ˆCardinalityï¼‰å¾ˆä½Žçš„åˆ—ï¼ˆå¦‚çŠ¶æ€ã€æ€§åˆ«ï¼‰ï¼Œä¸é€‚åˆå•ç‹¬åˆ›å»ºç´¢å¼•ã€‚
    *   **åˆ›å»ºè”åˆç´¢å¼•**ï¼šå°†é€‰æ‹©æ€§ä½Žçš„åˆ—ä¸Žé€‰æ‹©æ€§é«˜çš„åˆ—ç»„åˆæˆè”åˆç´¢å¼•ã€‚ä¾‹å¦‚ï¼Œ`ALTER TABLE users ADD INDEX idx_status_createtime(status, create_time);`ã€‚è¿™æ ·æŸ¥è¯¢ `WHERE status = 1 AND create_time > '2023-01-01'` å°±èƒ½é«˜æ•ˆå¾—å¤šã€‚

#### 1.2 æ£€æŸ¥ `Extra` åˆ—ï¼šå‘çŽ°éšè—çš„æ€§èƒ½æ€æ‰‹

*   **é—®é¢˜**ï¼š`Extra` åˆ—æ˜¯å¦å‡ºçŽ°äº† `Using filesort` æˆ– `Using temporary`ï¼Ÿ
*   **`Using filesort`**ï¼š
    *   **åŽŸå› **ï¼šè¿™è¯´æ˜Ž MySQL æ— æ³•åˆ©ç”¨ç´¢å¼•çš„æœ‰åºæ€§æ¥æ»¡è¶³ `ORDER BY` å­å¥ï¼Œå¿…é¡»åœ¨å†…å­˜æˆ–ç£ç›˜ä¸Šè¿›è¡Œé¢å¤–çš„æŽ’åºæ“ä½œã€‚
    *   **ç¤ºä¾‹**ï¼šè¡¨ `posts` æœ‰è”åˆç´¢å¼• `idx_author_views(author_id, view_count)`ã€‚
        ```sql
        -- æ— æ³•åˆ©ç”¨ç´¢å¼•æŽ’åºï¼Œäº§ç”Ÿ filesort
        EXPLAIN SELECT * FROM posts WHERE author_id = 123 ORDER BY create_time;
        ```
    *   **å¯¹ç­–**ï¼šä¿®æ”¹ç´¢å¼•ä»¥åŒ¹é…æŽ’åºè§„åˆ™ã€‚åˆ›å»º `idx_author_createtime(author_id, create_time)`ï¼Œè¿™æ ·æŸ¥è¯¢å°±å¯ä»¥åˆ©ç”¨ç´¢å¼•çš„æœ‰åºæ€§ï¼Œé¿å…æ–‡ä»¶æŽ’åºã€‚
*   **`Using temporary`**ï¼š
    *   **åŽŸå› **ï¼šé€šå¸¸å‘ç”Ÿåœ¨ `GROUP BY` æˆ– `UNION` æ“ä½œä¸­ï¼ŒMySQL éœ€è¦åˆ›å»ºä¸´æ—¶è¡¨æ¥å­˜å‚¨ä¸­é—´ç»“æžœã€‚
    *   **ç¤ºä¾‹**ï¼š
        ```sql
        -- GROUP BY çš„åˆ—ä¸Ž ORDER BY çš„åˆ—ä¸ä¸€è‡´ï¼Œå¯èƒ½äº§ç”Ÿä¸´æ—¶è¡¨å’Œæ–‡ä»¶æŽ’åº
        EXPLAIN SELECT author_id, COUNT(*) FROM posts GROUP BY author_id ORDER BY COUNT(*);
        ```
    *   **å¯¹ç­–**ï¼šå°½é‡é€šè¿‡ä¼˜åŒ–ç´¢å¼•é¡ºåºæ¥é¿å…ã€‚ä¾‹å¦‚ï¼Œä¸º `GROUP BY` çš„åˆ—åˆ›å»ºç´¢å¼•ï¼Œå¹¶ç¡®ä¿ `ORDER BY` çš„æ¡ä»¶ä¸Ž `GROUP BY` ä¸€è‡´ã€‚

### ç¬¬ 2 æ­¥ï¼šåˆ†æžç´¢å¼•ä¸ŽæŸ¥è¯¢çš„åŒ¹é…åº¦

### 2.1 æ£€æŸ¥æ˜¯å¦è§¦å‘â€œå›žè¡¨â€è¿‡å¤š

*   **é—®é¢˜**ï¼šæŸ¥è¯¢æ˜¯å¦æ˜¯ `SELECT *`ï¼Ÿæˆ–è€…æŸ¥è¯¢çš„åˆ—æ²¡æœ‰è¢«ç´¢å¼•å®Œå…¨è¦†ç›–ï¼Ÿ
*   **åŽŸå› **ï¼šå³ä½¿ `WHERE` æ¡ä»¶å‘½ä¸­äº†ç´¢å¼•ï¼Œä½†å¦‚æžœæŸ¥è¯¢çš„åˆ—ä¸åœ¨è¿™ä¸ªç´¢å¼•æ ‘ä¸Šï¼ŒMySQL å°±éœ€è¦è¿›è¡Œ**å›žè¡¨**æ“ä½œï¼šé€šè¿‡è¾…åŠ©ç´¢å¼•æ‰¾åˆ°ä¸»é”® IDï¼Œå†æ ¹æ®ä¸»é”® ID åŽ»èšç°‡ç´¢å¼•ä¸­æŸ¥æ‰¾å®Œæ•´çš„è¡Œæ•°æ®ã€‚å½“å›žè¡¨çš„è¡Œæ•°éžå¸¸å¤šæ—¶ï¼Œå¤§é‡çš„éšæœº I/O ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚
*   **ç¤ºä¾‹**ï¼šè¡¨ `orders` æœ‰ç´¢å¼• `idx_user_id(user_id)`ã€‚
    ```sql
    -- èµ°äº† idx_user_id ç´¢å¼•ï¼Œä½†éœ€è¦å›žè¡¨èŽ·å– order_amount å’Œ order_status
    EXPLAIN SELECT * FROM orders WHERE user_id = 1001;
    ```
    å¦‚æžœç”¨æˆ· 1001 æœ‰ 10 ä¸‡ä¸ªè®¢å•ï¼Œå°±éœ€è¦è¿›è¡Œ 10 ä¸‡æ¬¡å›žè¡¨æ“ä½œã€‚
*   **å¯¹ç­–**ï¼š
    *   **ä½¿ç”¨è¦†ç›–ç´¢å¼•**ï¼šè®©ç´¢å¼•åŒ…å«æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„åˆ—ã€‚
        ```sql
        -- åˆ›å»ºè¦†ç›–ç´¢å¼•
        ALTER TABLE orders ADD INDEX idx_user_amount_status(user_id, order_amount, order_status);
        
        -- è¿™ä¸ªæŸ¥è¯¢å°†æ— éœ€å›žè¡¨ï¼ŒExtra ä¸­æ˜¾ç¤º Using index
        EXPLAIN SELECT user_id, order_amount, order_status FROM orders WHERE user_id = 1001;
        ```
    *   **é¿å… `SELECT *`**ï¼šåªæŸ¥è¯¢ä¸šåŠ¡éœ€è¦çš„åˆ—ï¼Œè¿™æ˜¯å‡å°‘å›žè¡¨ã€å¢žåŠ å‘½ä¸­è¦†ç›–ç´¢å¼•å¯èƒ½æ€§çš„å¥½ä¹ æƒ¯ã€‚

#### 2.2 æ£€æŸ¥ç´¢å¼•åˆ—æ˜¯å¦â€œå¹²å‡€â€

*   **é—®é¢˜**ï¼š`WHERE` å­å¥ä¸­çš„ç´¢å¼•åˆ—æ˜¯å¦è¢«å‡½æ•°åŒ…è£¹ï¼Œæˆ–å­˜åœ¨ç±»åž‹ä¸åŒ¹é…ï¼Ÿ
*   **åŽŸå› **ï¼šå¯¹ç´¢å¼•åˆ—ä½¿ç”¨å‡½æ•°ã€è¿›è¡Œè®¡ç®—æˆ–éšå¼ç±»åž‹è½¬æ¢ï¼Œéƒ½ä¼šå¯¼è‡´ä¼˜åŒ–å™¨æ”¾å¼ƒä½¿ç”¨ç´¢å¼•ã€‚
*   **ç¤ºä¾‹**ï¼š
    ```sql
    -- é”™è¯¯ï¼šåœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°
    SELECT * FROM users WHERE DATE(create_time) = '2023-10-01';
    
    -- æ­£ç¡®ï¼šä¿æŒç´¢å¼•åˆ—å¹²å‡€
    SELECT * FROM users WHERE create_time >= '2023-10-01 00:00:00' AND create_time <= '2023-10-01 23:59:59';

    -- é”™è¯¯ï¼šå­—ç¬¦ä¸²åˆ—ä¸Žæ•°å­—æ¯”è¾ƒï¼Œå‘ç”Ÿéšå¼è½¬æ¢
    -- å‡è®¾ mobile æ˜¯ varchar ç±»åž‹
    SELECT * FROM users WHERE mobile = 13800001111;
    
    -- æ­£ç¡®ï¼šä½¿ç”¨æ­£ç¡®çš„ç±»åž‹
    SELECT * FROM users WHERE mobile = '13800001111';
    ```

### ç¬¬ 3 æ­¥ï¼šæ£€æŸ¥æ•°æ®åˆ†å¸ƒå’Œç³»ç»Ÿèµ„æº

#### 3.1 æ£€æŸ¥è¿”å›žçš„ç»“æžœé›†æ˜¯å¦è¿‡å¤§

*   **é—®é¢˜**ï¼šæŸ¥è¯¢æœ¬èº«æ‰§è¡Œå¾ˆå¿«ï¼Œä½†éœ€è¦è¿”å›žçš„è¡Œæ•°å’Œæ•°æ®é‡æœ¬èº«å°±éžå¸¸å·¨å¤§ã€‚
*   **åŽŸå› **ï¼šç“¶é¢ˆå¯èƒ½ä¸åœ¨æ•°æ®åº“æŸ¥è¯¢ï¼Œè€Œåœ¨äºŽ**ç½‘ç»œä¼ è¾“**å’Œå®¢æˆ·ç«¯å¤„ç†æ•°æ®çš„å¼€é”€ã€‚
*   **å¯¹ç­–**ï¼šåœ¨ä¸šåŠ¡å±‚é¢è¿›è¡Œåæ€ï¼Œæ˜¯å¦çœŸçš„éœ€è¦ä¸€æ¬¡æ€§è¿”å›žè¿™ä¹ˆå¤šæ•°æ®ã€‚é€šå¸¸çš„è§£å†³æ–¹æ¡ˆæ˜¯**åˆ†é¡µæŸ¥è¯¢** (`LIMIT`)ã€‚

#### 3.2 æ£€æŸ¥ I/O ç“¶é¢ˆ

*   **é—®é¢˜**ï¼šæ•°æ®åº“æœåŠ¡å™¨çš„ç£ç›˜ I/O æ˜¯å¦å·²ç»é¥±å’Œï¼Ÿ
*   **åŽŸå› **ï¼šå³ä½¿èµ°äº†ç´¢å¼•ï¼Œæ•°æ®æœ€ç»ˆè¿˜æ˜¯è¦ä»Žç£ç›˜è¯»å–ã€‚å¦‚æžœ `innodb_buffer_pool_size` é…ç½®ä¸å½“ï¼Œå¯¼è‡´çƒ­ç‚¹æ•°æ®æ— æ³•å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ï¼ŒæŸ¥è¯¢å°±ä¼šäº§ç”Ÿå¤§é‡çš„ç‰©ç† I/Oã€‚
*   **å¯¹ç­–**ï¼š
    *   ä½¿ç”¨ `iostat`ã€`iotop` ç­‰ Linux å‘½ä»¤æ£€æŸ¥ç£ç›˜ I/O çŠ¶æ€ã€‚
    *   åˆç†é…ç½® `innodb_buffer_pool_size`ï¼Œç›®æ ‡æ˜¯è®© Buffer Pool èƒ½å¤Ÿç¼“å­˜ç»å¤§éƒ¨åˆ†çƒ­ç‚¹æ•°æ®ã€‚

### ç¬¬ 4 æ­¥ï¼šæ£€æŸ¥å¹¶å‘ä¸Žé”é—®é¢˜

*   **é—®é¢˜**ï¼šæŸ¥è¯¢æ˜¯å¦åœ¨ç­‰å¾…æŸä¸ªè¡Œé”æˆ–è¡¨é”ï¼Ÿ
*   **åŽŸå› **ï¼šå¦‚æžœæœ‰ä¸€ä¸ªé•¿æ—¶é—´æœªæäº¤çš„äº‹åŠ¡é”å®šäº†ä½ çš„æŸ¥è¯¢éœ€è¦è®¿é—®çš„è¡Œï¼Œä½ çš„æŸ¥è¯¢å°±ä¼šä¸€ç›´å¤„äºŽç­‰å¾…çŠ¶æ€ã€‚
*   **å¯¹ç­–**ï¼š
    *   ä½¿ç”¨ `SHOW PROCESSLIST;` æŸ¥çœ‹å½“å‰æ‰€æœ‰è¿žæŽ¥çš„çŠ¶æ€ï¼Œå…³æ³¨ `State` åˆ—æ˜¯å¦ä¸º `Locked`ã€‚
    *   æŸ¥è¯¢ `information_schema` ä¸‹çš„ `innodb_trx`, `innodb_locks`, `innodb_lock_waits` ç­‰ç³»ç»Ÿè¡¨ï¼Œå¯ä»¥ç²¾ç¡®åœ°å®šä½åˆ°æ˜¯å“ªä¸ªäº‹åŠ¡é˜»å¡žäº†å“ªä¸ªäº‹åŠ¡ã€‚

## æ­»é”çš„å…¸åž‹åœºæ™¯

ç†è§£æ­»é”çš„åŽŸç†åŽï¼Œæˆ‘ä»¬æ¥çœ‹å‡ ä¸ªåœ¨å®žé™…å¼€å‘ä¸­éžå¸¸å…¸åž‹çš„æ­»é”åœºæ™¯ã€‚

#### åœºæ™¯ä¸€ï¼šç»å…¸çš„ AB-BA äº’é”

è¿™æ˜¯æœ€ç›´è§‚çš„æ­»é”å½¢å¼ï¼Œä¸¤ä¸ªäº‹åŠ¡ä»¥ç›¸åçš„é¡ºåºè¯·æ±‚ä¸¤ä¸ªç›¸åŒçš„èµ„æºã€‚

**å‰æ**ï¼š
*   è¡¨ `products`ï¼Œæœ‰ä¸»é”® `id`ã€‚
*   äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸º**è¯»å·²æäº¤ (Read Committed)** æˆ– **å¯é‡å¤è¯» (Repeatable Read)**ã€‚

**æ“ä½œæ—¶åº**ï¼š

| æ—¶é—´ | äº‹åŠ¡ A (Session A)                                     | äº‹åŠ¡ B (Session B)                                     |
| :--- | :----------------------------------------------------- | :----------------------------------------------------- |
| T1   | `BEGIN;`                                               | `BEGIN;`                                               |
| T2   | `UPDATE products SET stock = stock - 1 WHERE id = 10;` |                                                        |
|      | (æˆåŠŸï¼ŒæŒæœ‰ id=10 çš„è¡Œé”)                              |                                                        |
| T3   |                                                        | `UPDATE products SET stock = stock - 1 WHERE id = 20;` |
|      |                                                        | (æˆåŠŸï¼ŒæŒæœ‰ id=20 çš„è¡Œé”)                              |
| T4   | `UPDATE products SET stock = stock - 1 WHERE id = 20;` |                                                        |
|      | (**é˜»å¡ž**ï¼Œç­‰å¾…äº‹åŠ¡ B é‡Šæ”¾ id=20 çš„è¡Œé”)               |                                                        |
| T5   |                                                        | `UPDATE products SET stock = stock - 1 WHERE id = 10;` |
|      |                                                        | (**é˜»å¡ž**ï¼Œç­‰å¾…äº‹åŠ¡ A é‡Šæ”¾ id=10 çš„è¡Œé”)               |

**ç»“æžœ**ï¼š
*   äº‹åŠ¡ A ç­‰å¾…äº‹åŠ¡ Bï¼Œäº‹åŠ¡ B ç­‰å¾…äº‹åŠ¡ Aï¼Œå½¢æˆ**ç­‰å¾…çŽ¯**ã€‚
*   InnoDB çš„æ­»é”æ£€æµ‹æœºåˆ¶ä¼šå‘çŽ°è¿™ä¸ªçŽ¯ï¼Œå¹¶é€‰æ‹©ä¸€ä¸ªäº‹åŠ¡ï¼ˆå¦‚äº‹åŠ¡ Bï¼‰è¿›è¡Œå›žæ»šï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ï¼ˆäº‹åŠ¡ Aï¼‰åˆ™å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚

**é¿å…æ–¹æ³•**ï¼š
*   ä¸¥æ ¼éµå¾ª**â€œä»¥å›ºå®šçš„é¡ºåºè®¿é—®èµ„æºâ€**çš„åŽŸåˆ™ã€‚ç¡®ä¿æ‰€æœ‰éœ€è¦åŒæ—¶é”å®šå¤šè¡Œè®°å½•çš„ä¸šåŠ¡é€»è¾‘ï¼Œéƒ½æŒ‰ç…§ç›¸åŒçš„é¡ºåºï¼ˆä¾‹å¦‚ï¼ŒæŒ‰ä¸»é”® `id` ä»Žå°åˆ°å¤§çš„é¡ºåºï¼‰æ¥æ‰§è¡Œ `UPDATE` æˆ– `DELETE` æ“ä½œã€‚

#### åœºæ™¯äºŒï¼šé—´éš™é” (Gap Lock) å¯¼è‡´çš„æ­»é”

è¿™æ˜¯åœ¨ **å¯é‡å¤è¯» (RR)** éš”ç¦»çº§åˆ«ä¸‹ç‰¹æœ‰çš„ã€æ›´éšè”½çš„æ­»é”åœºæ™¯ï¼Œé€šå¸¸å‘ç”Ÿåœ¨å¹¶å‘ `INSERT` æ—¶ã€‚

**å‰æ**ï¼š
*   è¡¨ `users`ï¼Œæœ‰ä¸»é”® `id` å’Œå”¯ä¸€ç´¢å¼• `idx_unique_name(name)`ã€‚
*   è¡¨ä¸­å·²æœ‰æ•°æ®ï¼š`(id=10, name='Alice')`, `(id=30, name='David')`ã€‚
*   äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸º**å¯é‡å¤è¯» (Repeatable Read)**ã€‚

**æ“ä½œæ—¶åº**ï¼š

| æ—¶é—´ | äº‹åŠ¡ A (Session A)                                     | äº‹åŠ¡ B (Session B)                                     |
| :--- | :----------------------------------------------------- | :----------------------------------------------------- |
| T1   | `BEGIN;`                                               | `BEGIN;`                                               |
| T2   | `SELECT * FROM users WHERE name = 'Bob' FOR UPDATE;`   |                                                        |
|      | (æˆåŠŸï¼Œå› ä¸º 'Bob' ä¸å­˜åœ¨ï¼Œåœ¨ `idx_unique_name` ç´¢å¼•ä¸Šï¼Œé”å®šäº† 'Alice' å’Œ 'David' ä¹‹é—´çš„**é—´éš™é” (Gap Lock)**) |                                                        |
| T3   |                                                        | `SELECT * FROM users WHERE name = 'Charles' FOR UPDATE;` |
|      |                                                        | (æˆåŠŸï¼Œå› ä¸º 'Charles' ä¸å­˜åœ¨ï¼ŒåŒæ ·é”å®šäº† 'Alice' å’Œ 'David' ä¹‹é—´çš„**é—´éš™é”**) |
| T4   | `INSERT INTO users(name) VALUES ('Bob');`              |                                                        |
|      | (**é˜»å¡ž**ï¼Œå› ä¸ºæ’å…¥ 'Bob' éœ€è¦åœ¨é—´éš™ä¸­èŽ·å–æ’å…¥æ„å‘é”ï¼Œä½†è¯¥é—´éš™å·²è¢«äº‹åŠ¡ B çš„é—´éš™é”é˜»å¡ž) |                                                        |
| T5   |                                                        | `INSERT INTO users(name) VALUES ('Charles');`          |
|      |                                                        | (**é˜»å¡ž**ï¼ŒåŒæ ·ï¼Œæ’å…¥ 'Charles' ä¹Ÿéœ€è¦èŽ·å–æ’å…¥æ„å‘é”ï¼Œä½†è¯¥é—´éš™å·²è¢«äº‹åŠ¡ A çš„é—´éš™é”é˜»å¡ž) |

**ç»“æžœ**ï¼š
*   äº‹åŠ¡ A å’Œäº‹åŠ¡ B éƒ½æˆåŠŸèŽ·å–äº†åŒä¸€ä¸ªé—´éš™çš„é—´éš™é”ï¼ˆS æ¨¡å¼ï¼Œæ˜¯å…¼å®¹çš„ï¼‰ã€‚
*   å½“å®ƒä»¬éƒ½å°è¯•åœ¨è¯¥é—´éš™ä¸­æ’å…¥æ•°æ®æ—¶ï¼Œéƒ½éœ€è¦å°†è‡ªå·±çš„é—´éš™é”å‡çº§ä¸ºæ’å…¥æ„å‘é”ï¼Œä½†æ’å…¥æ„å‘é”ä¸Žå¯¹æ–¹æŒæœ‰çš„é—´éš™é”æ˜¯**å†²çª**çš„ã€‚
*   äº‹åŠ¡ A ç­‰å¾…äº‹åŠ¡ B é‡Šæ”¾é—´éš™é”ï¼Œäº‹åŠ¡ B ä¹Ÿç­‰å¾…äº‹åŠ¡ A é‡Šæ”¾é—´éš™é”ï¼Œå½¢æˆ**ç­‰å¾…çŽ¯**ï¼Œå¯¼è‡´æ­»é”ã€‚

**é¿å…æ–¹æ³•**ï¼š
*   **é™ä½Žéš”ç¦»çº§åˆ«**ï¼šå¦‚æžœä¸šåŠ¡å…è®¸ï¼Œå°†éš”ç¦»çº§åˆ«ä»Ž RR é™ä¸º RCï¼Œå› ä¸º RC çº§åˆ«ä¸‹æ²¡æœ‰é—´éš™é”ã€‚
*   **ä¸šåŠ¡é€»è¾‘è°ƒæ•´**ï¼šå°½é‡é¿å…åœ¨äº‹åŠ¡ä¸­å¯¹ä¸å­˜åœ¨çš„è®°å½•è¿›è¡Œ `SELECT ... FOR UPDATE`ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å…¶ä»–æ–¹å¼ï¼Œå¦‚å…ˆ `INSERT` å† `UPDATE` çš„é€»è¾‘ï¼ˆéœ€è¦å¤„ç†å”¯ä¸€é”®å†²çªï¼‰ã€‚
*   **ä½¿ç”¨å”¯ä¸€ç´¢å¼•**ï¼šå¦‚æžœæŸ¥è¯¢æ¡ä»¶æ˜¯å”¯ä¸€ç´¢å¼•çš„ç­‰å€¼æŸ¥è¯¢ï¼ŒInnoDB ä¼šå°†ä¸´é”®é”ä¼˜åŒ–ä¸ºè®°å½•é”ï¼Œä»Žè€Œé¿å…é—´éš™é”çš„äº§ç”Ÿã€‚